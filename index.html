<!DOCTYPE html>
<html lang="ko">
 <head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í‰ê· ì˜ ìˆ˜í˜¸ì: ë§¤ìŠ¤ ì„œë°”ì´ë²„</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-drag: none;
            touch-action: manipulation; /* í„°ì¹˜ ìµœì í™” */
        }

        /* ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €(íŠ¹íˆ Android Chrome)ì—ì„œ 100vhê°€ ì£¼ì†Œì°½/íˆ´ë°”ë¡œ ì¸í•´ ì˜ë¦¬ëŠ” ë¬¸ì œ ë°©ì§€ */
        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #1a202c;
            font-family: 'Jua', sans-serif;
            color: white;
            display: flex;
            width: 100vw;
            /* JSì—ì„œ --app-heightë¥¼ window.innerHeightë¡œ ê°±ì‹  (fallback: 100dvh/100vh) */
            height: var(--app-height, 100dvh);
            min-height: var(--app-height, 100dvh);
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ ì²˜ë¦¬ */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                /* flex ìì‹ì´ ë‚´ë¶€ì—ì„œ ìŠ¤í¬ë¡¤/ë¦¬ì‚¬ì´ì¦ˆë  ìˆ˜ ìˆë„ë¡ */
                min-height: 0;
            }
            #game-area {
                height: 60% !important;
                width: 100% !important;
                min-height: 0;
            }
            #sidebar {
                height: 40% !important;
                width: 100% !important;
                min-width: 0 !important;
                border-left: none !important;
                border-top: 4px solid #4a5568;
                padding: 10px !important;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                min-height: 0;
            }
            /* ëª¨ë°”ì¼ì—ì„œ í°íŠ¸ í¬ê¸° ì¡°ì • */
            .problem-box { font-size: 1rem !important; padding: 10px !important; margin-bottom: 10px !important; }
            .answer-input { padding: 10px !important; font-size: 1.2rem !important; }
            .submit-btn { padding: 10px !important; font-size: 1.1rem !important; }
            
            /* ëª¨ë°”ì¼ì—ì„œ UI ìœ„ì¹˜ ì¡°ì • */
            .rank-button { right: 90px !important; bottom: calc(15px + env(safe-area-inset-bottom)) !important; width: 60px !important; height: 60px !important; font-size: 0.8rem !important; }
            .shop-button { right: 15px !important; bottom: calc(15px + env(safe-area-inset-bottom)) !important; width: 60px !important; height: 60px !important; }
            .train-button { right: 15px !important; bottom: calc(90px + env(safe-area-inset-bottom)) !important; width: 60px !important; height: 60px !important; font-size: 0.9rem !important; }
            
            /* ëª¨ë°”ì¼ í†µê³„ íŒ¨ë„ ê°„ì†Œí™” ë˜ëŠ” í°íŠ¸ ì¶•ì†Œ */
            .math-stats { font-size: 0.8rem !important; padding: 8px !important; }
            .stat-row { font-size: 0.8rem !important; margin-bottom: 2px !important; }
            
            .skill-dock { bottom: calc(15px + env(safe-area-inset-bottom)) !important; gap: 10px !important; }
            .skill-slot { width: 50px !important; height: 50px !important; }
            .skill-slot span { font-size: 18px !important; }
        }

        /* === ì¢Œì¸¡ ê²Œì„ ì˜ì—­ === */
        #game-area {
            position: relative;
            flex-grow: 1;
            height: 100%;
            overflow: hidden;
            min-height: 0;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        /* UI ì˜¤ë²„ë ˆì´ (ì²´ë ¥, ê³¨ë“œ, ìŠ¤í‚¬ ë“±) */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* ìƒë‹¨ ìƒíƒœë°” */
        .hud-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: auto;
        }

        .status-bar {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 280px;
        }

        .bar-container {
            width: 100%;
            height: 22px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 11px;
            border: 2px solid #555;
            position: relative;
            overflow: hidden;
        }

        .hp-bar-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff4b1f, #ff9068); transition: width 0.2s; }
        .exp-bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #11998e, #38ef7d); transition: width 0.2s; }
        
        .bar-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 13px; text-shadow: 1px 1px 2px black; white-space: nowrap;
        }

        .currency-display {
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 20px;
            border-radius: 20px;
            border: 2px solid gold;
            color: gold;
            font-size: 1.4rem;
            display: flex; align-items: center; gap: 10px;
        }

        /* í•˜ë‹¨ ìŠ¤í‚¬ ìŠ¬ë¡¯ */
        .skill-dock {
            position: absolute;
            bottom: calc(20px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }

        .skill-slot {
            width: 70px; height: 70px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #777;
            border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.1s;
        }
        .skill-slot:active { transform: scale(0.95); }
        .skill-slot.active { border-color: #00ff00; box-shadow: 0 0 15px #00ff00; }
        .skill-slot.empty { opacity: 0.5; cursor: default; }

        .skill-count { position: absolute; bottom: 2px; right: 6px; font-size: 16px; color: white; }
        .skill-key { position: absolute; top: 2px; left: 6px; font-size: 11px; color: #aaa; }

        /* ìƒíƒœë°” í™•ì¥ */
        .stats-panel {
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 10px;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        /* í•™ìŠµ í†µê³„ ìŠ¤íƒ€ì¼ */
        .math-stats {
            background: #1a202c;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #4a5568;
            margin-bottom: 10px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.95rem;
            color: #cbd5e0;
        }
        .stat-row:last-child { margin-bottom: 0; }

        /* ìƒì  ë²„íŠ¼ */
        .shop-button {
            position: absolute; bottom: calc(20px + env(safe-area-inset-bottom)); right: calc(20px + env(safe-area-inset-right));
            background: linear-gradient(135deg, #ff9966, #ff5e62);
            border: none; border-radius: 50%; width: 70px; height: 70px;
            color: white; font-size: 1rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); pointer-events: auto;
        }

        /* === ìš°ì¸¡ ì‚¬ì´ë“œë°” (ë¬¸ì œ ì˜ì—­) === */
        #sidebar {
            width: 380px;
            min-width: 380px;
            background: #2d3748;
            border-left: 4px solid #4a5568;
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            /* ëª¨ë°”ì¼ì—ì„œ ë‚´ìš©ì´ ê¸¸ì–´ì§ˆ ë•Œ ì˜ë¦¼ ë°©ì§€(PCì—ì„œë„ ìŠ¤í¬ë¡¤ ê°€ëŠ¥) */
            overflow-y: auto;
            min-height: 0;
        }

        .sidebar-header {
            font-size: 1.5rem;
            color: #4fd1c5;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #4a5568;
            padding-bottom: 10px;
        }

        /* ë¬¸ì œ í‘œì‹œ ì˜ì—­ */
        #quiz-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .problem-box {
            background: #1a202c;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.3rem;
            line-height: 1.6;
        color: #e2e8f0;
            white-space: pre-line;
            border: 2px solid #4a5568;
        }

        .input-group {
            margin-bottom: 20px;
        }
        
        .answer-input {
            width: 100%;
            padding: 15px;
            font-size: 1.5rem;
            border: 3px solid #4fd1c5;
            border-radius: 10px;
            background: #1a202c;
            color: white;
            font-family: 'Jua', sans-serif;
            text-align: center;
            margin-bottom: 10px;
            user-select: auto; /* ì…ë ¥ í—ˆìš© */
        }
        
        /* type=number í™”ì‚´í‘œ ì œê±° */
        .answer-input::-webkit-outer-spin-button,
        .answer-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.3rem;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .submit-btn:active { transform: scale(0.98); }

        /* ì—…ê·¸ë ˆì´ë“œ ì„ íƒ ëª¨ë“œ */
        #upgrade-container {
            display: none;
                flex-direction: column;
                gap: 10px;
            }
            
        .upgrade-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
                padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, border 0.2s;
            border: 2px solid transparent;
            text-align: center;
        }
        .upgrade-card:hover { transform: translateY(-3px); border-color: white; }
        .upgrade-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 5px; }
        .upgrade-desc { font-size: 1rem; opacity: 0.9; }

        /* ì•Œë¦¼ ë©”ì‹œì§€ */
        .toast {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            z-index: 2000;
            white-space: nowrap;
        }

        /* ì‹œì‘ í™”ë©´ */
        #start-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a202c, #2d3748);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 3000;
        }
        .start-btn {
            padding: 15px 50px; font-size: 2rem;
            background: linear-gradient(90deg, #f6d365, #fda085);
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 10px 20px rgba(253, 160, 133, 0.4);
            font-family: 'Jua', sans-serif;
        }

        /* ìƒì  ëª¨ë‹¬ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 2500;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #2d3748; border: 4px solid gold;
            border-radius: 20px; padding: 30px; width: 500px; text-align: center;
        }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .shop-item { background: #1a202c; padding: 15px; border-radius: 10px; cursor: pointer; border: 1px solid #555; }
        .shop-item:hover { border-color: gold; }

        /* ë­í‚¹ ë²„íŠ¼ - ìƒì  ë²„íŠ¼ ì™¼ìª½ */
        .rank-button {
            position: absolute;
            bottom: calc(20px + env(safe-area-inset-bottom));
            right: calc(110px + env(safe-area-inset-right)); /* ìƒì  ë²„íŠ¼ ì˜† */
            background: linear-gradient(135deg, #a18cd1, #fbc2eb);
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            pointer-events: auto;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* ë­í‚¹ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .rank-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #e2e8f0;
        }
        .rank-table th, .rank-table td {
            padding: 10px;
            border-bottom: 1px solid #4a5568;
            text-align: center;
        }
        .rank-table th {
            background: #2d3748;
            color: #4fd1c5;
        }
        .my-rank {
            background: rgba(79, 209, 197, 0.2);
            font-weight: bold;
            color: #fff;
        }

        /* ë‹‰ë„¤ì„ ì…ë ¥ ëª¨ë‹¬ */
        #name-modal {
            z-index: 3500;
        }
        .name-input {
            width: 80%;
            padding: 10px;
            font-size: 1.2rem;
            border-radius: 5px;
            border: 2px solid #4a5568;
            background: #1a202c;
            color: white;
            margin: 20px 0;
            text-align: center;
        }

    </style>
</head>
 <body>

    <!-- ì¢Œì¸¡ ê²Œì„ ì˜ì—­ -->
    <div id="game-area">
        <canvas id="gameCanvas"></canvas>
        
        <div id="ui-layer">
            <div class="hud-top">
                <div class="status-bar">
                    <div class="bar-container">
                        <div class="hp-bar-fill" id="hpBar"></div>
                        <div class="bar-text" id="hpText">HP 100/100</div>
                    </div>
                    <!-- ìƒì„¸ ìŠ¤íƒ¯ íŒ¨ë„ ì¶”ê°€ -->
                    <div class="stats-panel">
                        <div>ë‚œì´ë„: <span id="diff-display" style="color:#4fd1c5">í‰í™”</span></div>
                        <div style="font-size: 0.8rem; margin-top:5px; color:#aaa;">
                            âš”ï¸ ë‚´ ê³µê²©ë ¥: <span id="stat-dmg">25</span> <br>
                            âš¡ ì—°ì‚¬ì†ë„: <span id="stat-spd">1.25</span>/s <br>
                            ğŸ¹ ë°œì‚¬ì²´ìˆ˜: <span id="stat-cnt">1</span> <br>
                            ğŸ‘¾ ì  ê³µê²©ë ¥: <span id="enemy-dmg" style="color:#f56565">0.5</span> <br>
                            â³ ìµœì¥ìƒì¡´: <span id="max-time" style="color:#ffd700">00:00</span>
                        </div>
                    </div>
                </div>
                <div class="currency-display">
                    <span>ğŸ’°</span><span id="goldDisplay">0</span>
                </div>
            </div>
            
            <!-- ì¤‘ì•™ ìƒë‹¨ íƒ€ì´ë¨¸ ì¶”ê°€ -->
            <div id="timer-display" style="position:absolute; top:15px; left:50%; transform:translateX(-50%); font-size:2rem; font-weight:bold; text-shadow:0 0 5px black; pointer-events:none;">
                00:00
            </div>

            <div class="skill-dock" id="skillDock">
                <div class="skill-slot empty" onclick="useSkill('bomb')">
                    <span style="font-size:24px">ğŸ’£</span><span class="skill-count" id="cnt-bomb">0</span><span class="skill-key">1</span>
                </div>
                <div class="skill-slot empty" onclick="useSkill('heal')">
                    <span style="font-size:24px">â¤ï¸</span><span class="skill-count" id="cnt-heal">0</span><span class="skill-key">2</span>
                </div>
                <div class="skill-slot empty" onclick="useSkill('shield')">
                    <span style="font-size:24px">ğŸ›¡ï¸</span><span class="skill-count" id="cnt-shield">0</span><span class="skill-key">3</span>
                </div>
            </div>

            <button class="rank-button" onclick="openRankingModal()">ğŸ† ë­í‚¹</button>
            <button class="shop-button" onclick="game.toggleShop()">ìƒì </button>
        </div>
    </div>

    <!-- ìš°ì¸¡ ì‚¬ì´ë“œë°” (ë¬¸ì œ ì˜ì—­) -->
    <div id="sidebar">
        <div class="sidebar-header">ë¡œë´‡ ê³µê²© ë°©ì–´ ì§€ì›ì‹¤</div>
        
        <!-- í•™ìŠµ í†µê³„ íŒ¨ë„ ì¶”ê°€ -->
        <div class="math-stats">
            <div class="stat-row"><span>ğŸ”¢ ì´ ë¬¸ì œ ìˆ˜</span><span id="stat-total-problems">1</span></div>
            <div class="stat-row"><span>âœï¸ í’€ì´ ì‹œë„ íšŸìˆ˜</span><span id="stat-attempts">0</span></div>
            <div class="stat-row"><span>â­• ì •ë‹µ íšŸìˆ˜</span><span id="stat-correct">0</span></div>
            <div class="stat-row"><span>âŒ ì˜¤ë‹µ íšŸìˆ˜</span><span id="stat-wrong">0</span></div>
            <div class="stat-row"><span>ğŸ”¥ í˜„ì¬ ê²Œì„ ì—°ì† ì •ë‹µìˆ˜</span><span id="stat-combo" style="color:#f6ad55">0</span></div>
            <div class="stat-row"><span>ğŸ† ìµœê³  ì—°ì† ì •ë‹µìˆ˜ ê¸°ë¡</span><span id="stat-max-combo">0</span></div>
            <div class="stat-row"><span>ğŸ“Š ì •ë‹µë¥ </span><span id="stat-accuracy">0%</span></div>
        </div>

        <hr style="border: 0; border-top: 1px solid #4a5568; margin: 15px 0;">
        
        <!-- í€´ì¦ˆ ëª¨ë“œ -->
        <div id="quiz-container">
            <div class="problem-box" id="problem-text">
                ë¬¸ì œ ë¡œë”©ì¤‘...
        </div>
            <div class="input-group">
                <input type="number" id="answer-input" class="answer-input" placeholder="ì •ë‹µ ì…ë ¥" onkeydown="checkEnter(event)">
                <button class="submit-btn" onclick="submitAnswer()">ë°œì‚¬ (ì œì¶œ)</button>
                </div>
            <p style="font-size: 0.9rem; color: #aaa; text-align: center;">
                ì •ë‹µì„ ë§ì¶”ë©´ ìºë¦­í„°ê°€ ì—…ê·¸ë ˆì´ë“œ ë©ë‹ˆë‹¤!
            </p>
   </div>

        <!-- ì—…ê·¸ë ˆì´ë“œ ì„ íƒ ëª¨ë“œ -->
        <div id="upgrade-container">
            <div style="text-align:center; color:#4fd1c5; margin-bottom:10px;">ë³´ìƒì„ ì„ íƒí•˜ì„¸ìš”!</div>
            <!-- ë™ì  ìƒì„± -->
    </div>
   </div>
    
    <!-- ì‹œì‘ í™”ë©´ -->
    <div id="start-screen">
        <h1 style="font-size: 3rem; color: #4fd1c5; text-shadow: 0 0 20px rgba(79,209,197,0.5); margin-bottom: 20px;">
            ìš°ì£¼ì˜ ìˆ˜í˜¸ì: Average-Hero
        </h1>
        <p style="color: #cbd5e0; font-size: 1.2rem; margin-bottom: 40px; text-align: center; line-height: 1.6;">
            ì¢Œì¸¡ì—ì„œëŠ” ì „íˆ¬ê°€, ìš°ì¸¡ì—ì„œëŠ” ìˆ˜í•™ ë¬¸ì œê°€ ì§„í–‰ë©ë‹ˆë‹¤.<br>
            ë¬¸ì œë¥¼ í’€ì–´ ìºë¦­í„°ë¥¼ ì„±ì¥ì‹œí‚¤ê³  ì ì„ ë§‰ì•„ë‚´ì„¸ìš”!
        </p>
        <button class="start-btn" onclick="checkNameAndStart()">ì‘ì „ ê°œì‹œ</button>
    </div>

    <!-- ìƒì  ëª¨ë‹¬ -->
    <div id="shop-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="color: gold; margin-top: 0;">ë³´ê¸‰ ìƒì </h2>
            <p>ë³´ìœ  ê³¨ë“œ: <span id="shop-gold">0</span></p>
            <div class="shop-grid">
                <div class="shop-item" onclick="buySkill('bomb', 100)">
                    <div style="font-size: 30px;">ğŸ’£</div><div>ì „ë©¸ í­íƒ„</div><div style="color:gold">100G</div>
            </div>
                <div class="shop-item" onclick="buySkill('heal', 50)">
                    <div style="font-size: 30px;">â¤ï¸</div><div>ê¸´ê¸‰ íšŒë³µ</div><div style="color:gold">50G</div>
        </div>
                <div class="shop-item" onclick="buySkill('shield', 150)">
                    <div style="font-size: 30px;">ğŸ›¡ï¸</div><div>ë¬´ì  ë°©íŒ¨</div><div style="color:gold">150G</div>
    </div>
            </div>
            <button onclick="game.toggleShop()" style="margin-top: 20px; padding: 10px 30px; background: #4a5568; border:none; color:white; border-radius: 5px; cursor:pointer;">ë‹«ê¸°</button>
    </div>
  </div>

    <!-- ë­í‚¹ ëª¨ë‹¬ -->
    <div id="rank-modal" class="modal-overlay">
        <div class="modal-content" style="width: 600px; max-height: 80vh; overflow-y: auto;">
            <h2 style="color: #a18cd1; margin-top: 0;">ğŸ† ê¸€ë¡œë²Œ ë­í‚¹</h2>
            
            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
                <button onclick="loadRanking('level')" class="shop-item" style="padding:5px 15px; color:white;">ë ˆë²¨ìˆœ</button>
                <button onclick="loadRanking('problems')" class="shop-item" style="padding:5px 15px; color:white;">ë¬¸ì œìˆœ</button>
                <button onclick="loadRanking('combo')" class="shop-item" style="padding:5px 15px; color:white;">ì½¤ë³´ìˆœ</button>
                <button onclick="loadRanking('survival')" class="shop-item" style="padding:5px 15px; color:white;">ìƒì¡´ìˆœ</button>
                <button onclick="loadRanking('accuracy')" class="shop-item" style="padding:5px 15px; color:white;">ì •ë‹µë¥ ìˆœ</button>
            </div>

            <div id="rank-list-container">ë¡œë”©ì¤‘...</div>
            
            <button onclick="document.getElementById('rank-modal').style.display='none'" style="margin-top: 20px; padding: 10px 30px; background: #4a5568; border:none; color:white; border-radius: 5px; cursor:pointer;">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ë‹‰ë„¤ì„ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="name-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content" style="width: 400px;">
            <h2 style="color: #4fd1c5; margin-top: 0;">ìš”ì› ë“±ë¡</h2>
            <p>ë­í‚¹ì— ë“±ë¡ë  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="text" id="username-input" class="name-input" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 8ê¸€ì)" maxlength="8">
            <button onclick="submitName()" class="start-btn" style="font-size:1.2rem; padding:10px 30px;">í™•ì¸</button>
        </div>
    </div>

    <div id="toast" class="toast">ë©”ì‹œì§€</div>

    <!-- ì˜¤ë””ì˜¤ -->
    <audio id="bgm" loop><source src="berserk.mp3" type="audio/mp3"></audio>
    <audio id="sfx-shoot" src="swordattack.mp3"></audio>
    <audio id="sfx-hit" src="fireball-impact.mp3"></audio>
    <audio id="sfx-level" src="bonus-points-190035.mp3"></audio>
    <audio id="sfx-over" src="game-over-417465.mp3"></audio>

  <script>
        // === ëª¨ë°”ì¼ ë·°í¬íŠ¸ ë†’ì´ ë³´ì • (ì£¼ì†Œì°½/íˆ´ë°”ë¡œ ì¸í•œ 100vh ì˜ë¦¼ ë°©ì§€) ===
        (function setupAppHeight() {
            const docEl = document.documentElement;
            const setHeight = () => {
                const h = (window.visualViewport && window.visualViewport.height)
                    ? window.visualViewport.height
                    : window.innerHeight;
                docEl.style.setProperty('--app-height', `${Math.floor(h)}px`);
            };

            setHeight();
            window.addEventListener('resize', setHeight, { passive: true });
            window.addEventListener('orientationchange', setHeight, { passive: true });
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', setHeight, { passive: true });
                window.visualViewport.addEventListener('scroll', setHeight, { passive: true });
            }
        })();

        // === ë­í‚¹ ì‹œìŠ¤í…œ ===
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz7VCG_pMIv7vygJAsROEZGpdy53wFdUiCqjlb-cVVpf7bSa7iz9aV4NWeF1BA2tzUw/exec";
        let currentUser = "";

        function checkNameAndStart() {
            const storedName = localStorage.getItem('mathHeroName');
            if (storedName) {
                currentUser = storedName;
                
                // ì´ì–´í•˜ê¸° ë°ì´í„° í™•ì¸
                if (localStorage.getItem('mathSaveData')) {
                    if (confirm("ì €ì¥ëœ ê²Œì„ì´ ìˆìŠµë‹ˆë‹¤. ì´ì–´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        if (game.loadGame()) {
                            document.getElementById('start-screen').style.display = 'none';
                            // ì˜¤ë””ì˜¤ ì¤€ë¹„
                            const audioIds = ['bgm', 'sfx-shoot', 'sfx-hit', 'sfx-level', 'sfx-over'];
                            audioIds.forEach(id => { const a=document.getElementById(id); if(a) a.load(); });
                            
                            game.state = 'playing';
                            
                            // ì¤‘ìš”: ì‹œê°„ ê´€ë ¨ ë³€ìˆ˜ ì¬ì„¤ì •
                            const now = performance.now();
                            game.lastTime = now;
                            game.player.lastFire = now; // ì¦‰ì‹œ ë°œì‚¬ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
                            game.lastSpawn = now;       // ìŠ¤í° íƒ€ì´ë¨¸ë„ ë¦¬ì…‹

                            game.loop(now);
                            document.getElementById('bgm').play().catch(()=>{});
                            return;
                        }
                    } else {
                        // ì´ì–´í•˜ê¸° ì·¨ì†Œ ì‹œ ë°ì´í„° ì‚­ì œ
                        localStorage.removeItem('mathSaveData');
                    }
                }
                startGame();
            } else {
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('name-modal').style.display = 'flex';
                document.getElementById('username-input').focus();
            }
        }

        function submitName() {
            const input = document.getElementById('username-input');
            const name = input.value.trim();
            if (!name) {
                showToast("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }
            currentUser = name;
            localStorage.setItem('mathHeroName', name);
            document.getElementById('name-modal').style.display = 'none';
            startGame();
        }

        function sendRanking() {
            if (!currentUser) return;

            const data = {
                username: currentUser,
                level: game.player.level,
                problems: game.stats.correct, 
                maxCombo: game.stats.maxCombo,
                survivalTime: Math.floor(game.gameTime / 1000),
                attempts: game.stats.attempts, // ì‹œë„ íšŸìˆ˜ ì¶”ê°€
                timestamp: new Date().toISOString()
            };

            fetch(APPS_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors", // ì¤‘ìš”: êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ëŠ” no-cors í•„ìš”
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            }).then(() => {
                console.log("Ranking sent!");
            }).catch(err => console.error("Ranking error:", err));
        }

        function openRankingModal() {
            document.getElementById('rank-modal').style.display = 'flex';
            loadRanking('level');
        }

        function loadRanking(type) {
            const container = document.getElementById('rank-list-container');
            container.innerHTML = "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

            // ë‚´ ê¸°ë¡ ê°•ì¡°ë¥¼ ìœ„í•´ username íŒŒë¼ë¯¸í„° ì¶”ê°€
            const url = `${APPS_SCRIPT_URL}?type=${type}&username=${encodeURIComponent(currentUser || '')}`;

            fetch(url)
            .then(res => res.json())
            .then(data => {
                let html = `
                    <table class="rank-table">
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>ì´ë¦„</th>
                                <th>LV</th>
                                <th>ì •ë‹µ</th>
                                <th>ìµœëŒ€ì½¤ë³´</th>
                                <th>ìƒì¡´</th>
                                <th>ì •ë‹µë¥ </th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                if (data.length === 0) {
                    html += `<tr><td colspan="7">ë“±ë¡ëœ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                } else {
                    data.forEach((row, index) => {
                        const isMe = row.username === currentUser;
                        const rank = row.rank || (index + 1);
                        
                        // ì‹œê°„ í¬ë§·íŒ… (ì´ˆ -> ë¶„:ì´ˆ)
                        const sec = row.survivalTime || 0;
                        const min = Math.floor(sec / 60);
                        const s = sec % 60;
                        const timeStr = `${min}:${s.toString().padStart(2,'0')}`;

                        // ì •ë‹µë¥  ê³„ì‚° (attemptsê°€ ì—†ìœ¼ë©´ 0% ì²˜ë¦¬)
                        let acc = 0;
                        const attempts = row.attempts || 0; // ì„œë²„ì—ì„œ ë°›ì•„ì•¼ í•¨
                        const correct = row.problems || 0;
                        if (attempts > 0) acc = ((correct / attempts) * 100).toFixed(1);

                        html += `
                            <tr class="${isMe ? 'my-rank' : ''}">
                                <td>${rank}</td>
                                <td>${row.username}</td>
                                <td>${row.level}</td>
                                <td>${row.problems}</td>
                                <td>${row.maxCombo}</td>
                                <td>${timeStr}</td>
                                <td>${acc}%</td>
                            </tr>
                        `;
                    });
                }
                html += `</tbody></table>`;
                container.innerHTML = html;
            })
            .catch(err => {
                container.innerHTML = "ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                console.error(err);
            });
        }

        // === 1. ìˆ˜í•™ ë¬¸ì œ ìƒì„±ê¸° ===
        class MathGen {
            constructor() {
                this.names = ['ì² ìˆ˜', 'ì˜í¬', 'ë¯¼ìˆ˜', 'ì§€ìˆ˜', 'í˜„ìš°', 'ë¯¼ì§€', 'ìˆ˜í˜„', 'í˜¸ì§„'];
                // ìƒí™©ë³„ í…œí”Œë¦¿ ì •ì˜
                this.scenarios = [
                    { item: 'ìˆ˜í•™ ì‹œí—˜ ì ìˆ˜', unit: 'ì ', action: 'ë°›ì•˜ìŠµë‹ˆë‹¤', question: 'í‰ê·  ì ìˆ˜', range: [70, 95] },
                    { item: 'ê°€ì§€ê³  ìˆëŠ” ì‚¬íƒ•', unit: 'ê°œ', action: 'ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤', question: 'ì‚¬íƒ•ì˜ í‰ê·  ê°œìˆ˜', range: [10, 40] },
                    { item: 'ì¤„ë„˜ê¸° ê¸°ë¡', unit: 'íšŒ', action: 'í–ˆìŠµë‹ˆë‹¤', question: 'ì¤„ë„˜ê¸° ê¸°ë¡ì˜ í‰ê· ', range: [30, 80] },
                    { item: 'ì½ì€ ì±…', unit: 'ê¶Œ', action: 'ì½ì—ˆìŠµë‹ˆë‹¤', question: 'ì½ì€ ì±…ì˜ í‰ê·  ê¶Œìˆ˜', range: [5, 20] },
                    { item: 'ëª¨ì€ ë”±ì§€', unit: 'ì¥', action: 'ëª¨ì•˜ìŠµë‹ˆë‹¤', question: 'ëª¨ì€ ë”±ì§€ì˜ í‰ê·  ê°œìˆ˜', range: [15, 50] }
                ];
            }

            getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

            generateProblem(level) {
                const isReverse = Math.random() > 0.5; // 50% í™•ë¥ ë¡œ ì—­ì‚° ë¬¸ì œ
                const scenario = this.scenarios[Math.floor(Math.random() * this.scenarios.length)];
                const count = this.getRandomInt(2, 3); // 2~3ëª… ë“±ì¥
                
                // ì´ë¦„ ëœë¤ ì„ íƒ
                let currentNames = [...this.names].sort(() => 0.5 - Math.random()).slice(0, count);
                
                // ë‚œì´ë„ì— ë”°ë¥¸ ê°’ ë²”ìœ„ ì¡°ì •
                let minVal = scenario.range[0] + (level * 2);
                let maxVal = scenario.range[1] + (level * 2);
                
                // í‰ê· ê°’ ë¨¼ì € ê²°ì • (ì •ìˆ˜ ë‹µì„ ìœ„í•´)
                let avg = this.getRandomInt(minVal, maxVal);
                let total = avg * count;
                
                // ê°œë³„ ê°’ ìƒì„± (í‰ê·  ì£¼ë³€ ê°’ìœ¼ë¡œ)
                let values = [];
                let currentSum = 0;
                for(let i=0; i<count-1; i++) {
                    let val = this.getRandomInt(avg - 10, avg + 10);
                    if(val < 0) val = 0; // ìŒìˆ˜ ë°©ì§€
                    values.push(val);
                    currentSum += val;
                }
                // ë§ˆì§€ë§‰ ê°’ì€ í•©ê³„ë¥¼ ë§ì¶”ê¸° ìœ„í•´ ê³„ì‚°
                let lastVal = total - currentSum;
                // ë§Œì•½ ë§ˆì§€ë§‰ ê°’ì´ ìŒìˆ˜ë©´ ë³´ì • (ë‹¨ìˆœí•˜ê²Œ ëª¨ë‘ í‰ê· ê°’ìœ¼ë¡œ í†µì¼)
                if (lastVal < 0) {
                    values = new Array(count-1).fill(avg);
                    lastVal = avg;
                }
                values.push(lastVal);
                
                // ê°’ ì„ê¸°
                values.sort(() => 0.5 - Math.random());

                let question = '';
                let answer = 0;

                if (!isReverse) {
                    // === ì •ë°©í–¥: í‰ê·  êµ¬í•˜ê¸° ===
                    // ì˜ˆ: ì² ìˆ˜ëŠ” 10ê°œ, ì˜í¬ëŠ” 20ê°œë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. í‰ê· ì€?
                    let sentence = "";
                    for(let i=0; i<count; i++) {
                        // ì¡°ì‚¬ ì²˜ë¦¬ (ê°„ë‹¨íˆ)
                        let sub = i === count-1 ? "" : ", ";
                        sentence += `${currentNames[i]}ëŠ” ${values[i]}${scenario.unit}${sub}`;
                    }
                    sentence += `ì„(ë¥¼) ${scenario.action}.`;
                    
                    question = `${scenario.item}ì— ëŒ€í•œ ì¡°ì‚¬ ê²°ê³¼ì…ë‹ˆë‹¤.\n${sentence}\n\nì´ ì¹œêµ¬ë“¤ì˜ ${scenario.question}ëŠ” ì–¼ë§ˆì…ë‹ˆê¹Œ?`;
                    answer = avg;

            } else {
                    // === ì—­ë°©í–¥: ê°’ êµ¬í•˜ê¸° ===
                    // ì˜ˆ: ë‘ ëª…ì˜ í‰ê· ì€ 15ê°œì…ë‹ˆë‹¤. ì² ìˆ˜ê°€ 10ê°œë¼ë©´ ì˜í¬ëŠ”?
                    let groupName = count === 2 ? `${currentNames[0]}ì™€(ê³¼) ${currentNames[1]}` : `${count}ëª…ì˜ ì¹œêµ¬ë“¤`;
                    
                    question = `${groupName}ì˜ ${scenario.item} í‰ê· ì€ ${avg}${scenario.unit}ì…ë‹ˆë‹¤.\n`;
                    
                    let knownPart = "";
                    for(let i=0; i<count-1; i++) {
                        knownPart += `${currentNames[i]}ëŠ” ${values[i]}${scenario.unit}`;
                        if(i < count-2) knownPart += ", ";
                    }
                    question += `${knownPart}ì¼ ë•Œ,\n\në‚˜ë¨¸ì§€ ${currentNames[count-1]}ì˜ ê°’ì€ ì–¼ë§ˆì…ë‹ˆê¹Œ?`;
                    
                    answer = values[count-1];
                }

                return { question, answer };
            }
        }

        // === 2. ê²Œì„ ì—”ì§„ ===
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameArea = document.getElementById('game-area');

        // ì´ë¯¸ì§€
        const imgHero = new Image(); imgHero.src = 'hero.png';
        const imgEnemy = new Image(); imgEnemy.src = 'devilking.png';

        // ì „ì—­ ë³€ìˆ˜
        let currentProblem = null;
        let isInputFocused = false;

        class Game {
            constructor() {
                this.state = 'start'; 
                this.lastTime = 0;
                this.mathGen = new MathGen();
                
                this.player = {
                    x: 0, y: 0,
                    hp: 100, maxHp: 100,
                    level: 1,
                    damage: 25,
                    fireRate: 800,
                    lastFire: 0,
                    projectileCount: 1
                };

                this.gold = 0;
                this.skills = { bomb: 0, heal: 0, shield: 0 };
                this.isInvincible = false;

                this.enemies = [];
                this.bullets = [];
                this.particles = [];
                this.floatingTexts = [];

                this.spawnRate = 2000; // ì´ˆê¸° ìŠ¤í° 2ì´ˆ (ì—¬ìœ ë¡­ê²Œ ì‹œì‘)
                this.lastSpawn = 0;
                this.gameTime = 0; // ê²Œì„ ì§„í–‰ ì‹œê°„ ì¶”ì 

                // í†µê³„ ë°ì´í„°
                this.stats = {
                    totalProblems: 0, 
                    attempts: 0,
                    correct: 0,
                    wrong: 0,
                    combo: 0,
                    maxCombo: 0
                };

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìµœê³  ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                this.highScore = localStorage.getItem('mathHighLv') || 1;
                this.maxTime = parseFloat(localStorage.getItem('mathMaxTime')) || 0; // ms ë‹¨ìœ„

                window.addEventListener('resize', () => this.resize());
                // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì €ì¥
                window.addEventListener('beforeunload', () => this.saveGame());
                
                this.resize();
            }

            formatTime(ms) {
                const totalSec = Math.floor(ms / 1000);
                const m = Math.floor(totalSec / 60);
                const s = totalSec % 60;
                return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }

            resize() {
                // ì‚¬ì´ë“œë°”ë¥¼ ì œì™¸í•œ í¬ê¸°
                canvas.width = gameArea.clientWidth;
                canvas.height = gameArea.clientHeight;
                if (this.player.x === 0) {
                    this.player.x = canvas.width / 2;
                    this.player.y = canvas.height / 2;
                }
            }

            start() {
                document.getElementById('start-screen').style.display = 'none';
                this.state = 'playing';
                this.resize();
                this.player.x = canvas.width / 2;
                this.player.y = canvas.height / 2;

                this.loop(0);
                document.getElementById('bgm').play().catch(()=>{});
                
                this.updateHUD();
                this.updateSkillDock();
                this.nextProblem(); // ì²« ë¬¸ì œ ì¶œì œ
            }

            nextProblem() {
                // í€´ì¦ˆ ëª¨ë“œë¡œ ì „í™˜
                document.getElementById('quiz-container').style.display = 'flex';
                document.getElementById('upgrade-container').style.display = 'none';
                document.getElementById('answer-input').value = '';
                document.getElementById('answer-input').focus();

                currentProblem = this.mathGen.generateProblem(this.player.level);
                // ë¬¸ì œ ìƒì„± ì‹œ ì¹´ìš´íŠ¸ ì¦ê°€ (ì²« ë¬¸ì œëŠ” start()ì—ì„œ í˜¸ì¶œë˜ë¯€ë¡œ ì´ˆê¸°ê°’ 1ë¡œ ì„¤ì •í–ˆìŒ)
                // í•˜ì§€ë§Œ nextProblemì´ í˜¸ì¶œë  ë•Œë§ˆë‹¤ ì¦ê°€ì‹œí‚¤ëŠ” ê²ƒì´ ë¡œì§ìƒ ê¹”ë”í•¨.
                // start()ì—ì„œ nextProblemì„ ë¶€ë¥´ë¯€ë¡œ ì´ˆê¸°ê°’ì„ 0ìœ¼ë¡œ í•˜ê³  ì—¬ê¸°ì„œ ì¦ê°€ì‹œí‚´.
                this.stats.totalProblems++; 
                this.updateHUD(); // ì¦‰ì‹œ ë°˜ì˜
                
                document.getElementById('problem-text').innerText = `[LV.${this.player.level}]\n${currentProblem.question}`;
            }

            loop(timestamp) {
                if (this.state === 'paused' || this.state === 'gameover') {
                    if(this.state === 'paused') requestAnimationFrame((t) => this.loop(t)); // ë©ˆì¶°ìˆì–´ë„ ë£¨í”„ëŠ” ìœ ì§€ (ì¬ê°œ ìœ„í•´)
                return;
            }
            
                const dt = timestamp - this.lastTime;
                this.lastTime = timestamp;

                // ë¸íƒ€íƒ€ì„ ë³´ì • (ë„ˆë¬´ í° ê°’ ë°©ì§€)
                if (dt < 100) {
                    this.update(dt, timestamp);
                    this.draw();
                }

                requestAnimationFrame((t) => this.loop(t));
            }

            update(dt, timestamp) {
                this.gameTime += dt; // ê²Œì„ ì‹œê°„ ëˆ„ì 
                const seconds = this.gameTime / 1000;

                // === ë‚œì´ë„ ê³¡ì„  ì„¤ê³„ ===
                // 1. ì´ˆë°˜ 4ë¶„(240ì´ˆ): ìŠ¤í° ì†ë„ 2.0ì´ˆ -> 1.0ì´ˆë¡œ ì„œì„œíˆ ê°ì†Œ
                // 2. ì¤‘ë°˜(240ì´ˆ~): ìŠ¤í° ì†ë„ 1.0ì´ˆ -> 0.5ì´ˆ
                // 3. í›„ë°˜(480ì´ˆ~): ìŠ¤í° ì†ë„ 0.3ì´ˆ (ë¬¼ëŸ‰ í­ì£¼)
                
                let currentSpawnRate = 2000;
                if (seconds < 240) {
                    // 4ë¶„ê¹Œì§€ëŠ” ì²œì²œíˆ ë¹¨ë¼ì§
                    currentSpawnRate = 2000 - (seconds * 4); // 240ì´ˆì¼ ë•Œ ì•½ 1000ms
                } else if (seconds < 480) {
                    // 4ë¶„~8ë¶„: ì¡°ê¸ˆ ë” ë¹¨ë¼ì§
                    currentSpawnRate = 1000 - ((seconds - 240) * 2); // 480ì´ˆì¼ ë•Œ ì•½ 500ms
                } else {
                    // 8ë¶„ ì´í›„: ê·¹í•œ
                    currentSpawnRate = 500 - ((seconds - 480) * 3);
                    if (currentSpawnRate < 300) currentSpawnRate = 300;
                }
                this.spawnRate = currentSpawnRate;

                // ì  ìŠ¤í°
                if (timestamp - this.lastSpawn > this.spawnRate) {
                    this.spawnEnemy();
                    
                    // 4ë¶„ ì´í›„ë¶€í„° ë¬¼ëŸ‰ í­ì£¼ í™•ë¥  ìƒê¹€ (ì ì§„ì  ì¦ê°€)
                    if (seconds > 240 && Math.random() < 0.1) this.spawnEnemy(); 
                    if (seconds > 480 && Math.random() < 0.2) this.spawnEnemy();

                    this.lastSpawn = timestamp;
                }

                // ìë™ ê³µê²©
                if (timestamp - this.player.lastFire > this.player.fireRate) {
                    this.fireBullet();
                    this.player.lastFire = timestamp;
                }

                // ì´ì•Œ ì´ë™
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    let b = this.bullets[i];
                    b.x += b.vx * dt * 0.06;
                    b.y += b.vy * dt * 0.06;

                    if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) {
                        this.bullets.splice(i, 1);
                        continue;
                    }

                    for (let j = this.enemies.length - 1; j >= 0; j--) {
                        let e = this.enemies[j];
                        let dist = Math.hypot(b.x - e.x, b.y - e.y);
                        if (dist < e.radius + 5) {
                            e.hp -= this.player.damage;
                            this.showDamage(e.x, e.y, this.player.damage);
                            this.bullets.splice(i, 1);
                            if (e.hp <= 0) this.killEnemy(j);
                    break;    
            }
                    }
                }

                // ì  ì´ë™
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    let e = this.enemies[i];
                    let angle = Math.atan2(this.player.y - e.y, this.player.x - e.x);
                    e.x += Math.cos(angle) * e.speed * dt * 0.06;
                    e.y += Math.sin(angle) * e.speed * dt * 0.06;

                    let dist = Math.hypot(this.player.x - e.x, this.player.y - e.y);
                    // í”Œë ˆì´ì–´ í”¼ê²© ë²”ìœ„ ì¡°ì • (30 -> 60)
                    if (dist < 60 + e.radius) {
                        if (!this.isInvincible) {
                            // í”Œë ˆì´ì–´ í”¼ê²© ë°ë¯¸ì§€ ì¡°ì • (1.0 -> 0.5)
                            this.player.hp -= 0.5; 
                            this.updateHUD();
                            if (this.player.hp <= 0) this.gameOver();
                        }
                    }
                }

                // íŒŒí‹°í´
                this.particles.forEach((p, i) => {
                    p.life -= dt;
                    p.x += p.vx; p.y += p.vy;
                    if (p.life <= 0) this.particles.splice(i, 1);
                });
                
                // í…ìŠ¤íŠ¸
                this.floatingTexts.forEach((t, i) => {
                    t.life -= dt; t.y -= 0.5;
                    if (t.life <= 0) this.floatingTexts.splice(i, 1);
                });
            }

            draw() {
                // ìš°ì£¼ ë°°ê²½ ê·¸ë¦¬ê¸°
                // 1. ê¹Šì€ ìš°ì£¼ìƒ‰ ë°°ê²½
                ctx.fillStyle = '#0b0d17'; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 2. ë³„ ê·¸ë¦¬ê¸° (ëœë¤ ìœ„ì¹˜ì— ë³„ ìƒì„±)
                // ë§¤ í”„ë ˆì„ë§ˆë‹¤ ê·¸ë¦¬ë©´ ë²ˆì©ê±°ë¦¬ë¯€ë¡œ, ë¯¸ë¦¬ ìƒì„±ëœ ë³„ ë°°ì—´ì„ ì‚¬ìš©í•˜ê±°ë‚˜
                // ê°„ë‹¨í•˜ê²Œ ëœë¤ ì‹œë“œë¡œ ê³ ì •ëœ ë³„ì„ ê·¸ë¦¼.
                // ì—¬ê¸°ì„œëŠ” ì„±ëŠ¥ì„ ìœ„í•´ ë‹¨ìˆœ ë‚œìˆ˜ë¡œ ë§¤ë²ˆ ê·¸ë¦¬ì§€ ì•Šê³ ,
                // í™”ë©´ ì¢Œí‘œ ê¸°ë°˜ìœ¼ë¡œ ì˜ì‚¬ ë‚œìˆ˜ë¥¼ ìƒì„±í•˜ì—¬ ê³ ì •ëœ ë³„ì²˜ëŸ¼ ë³´ì´ê²Œ í•¨.
                
                ctx.fillStyle = '#ffffff';
                for (let i = 0; i < 100; i++) {
                    // ê°„ë‹¨í•œ í•´ì‹œ í•¨ìˆ˜ë¡œ ì¢Œí‘œ ê³ ì •
                    const x = (Math.sin(i * 123.45) * 0.5 + 0.5) * canvas.width;
                    const y = (Math.cos(i * 678.90) * 0.5 + 0.5) * canvas.height;
                    const size = (Math.sin(i * 999) + 2) / 2; // 0.5 ~ 1.5
                    const twinkle = Math.sin(performance.now() / 200 + i); // ë°˜ì§ì„
                    
                    ctx.globalAlpha = 0.5 + twinkle * 0.3;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1.0;

                // Enemies
                this.enemies.forEach(e => {
                    ctx.drawImage(imgEnemy, e.x - e.radius, e.y - e.radius, e.radius*2, e.radius*2);
                    // HP Bar
                    ctx.fillStyle = 'red'; ctx.fillRect(e.x-15, e.y-e.radius-8, 30, 4);
                    ctx.fillStyle = 'green'; ctx.fillRect(e.x-15, e.y-e.radius-8, 30*(e.hp/e.maxHp), 4);
                });

                // Bullets
                ctx.fillStyle = '#4fd1c5';
                this.bullets.forEach(b => {
                    ctx.beginPath(); ctx.arc(b.x, b.y, 8, 0, Math.PI*2); ctx.fill();
                });

                // Player
                ctx.save();
                ctx.translate(this.player.x, this.player.y);
                if (this.isInvincible && (Math.floor(Date.now()/100)%2===0)) ctx.globalAlpha = 0.5;
                
                // í”Œë ˆì´ì–´ í¬ê¸° 2ë°° (70x70 -> 140x140)
                ctx.drawImage(imgHero, -70, -70, 140, 140);
                
                if(this.isInvincible) {
                    ctx.beginPath(); ctx.strokeStyle='#00ffff'; ctx.lineWidth=3;
                    ctx.arc(0,0,80,0,Math.PI*2); ctx.stroke();
                }
                ctx.restore();

                // Particles
                this.particles.forEach(p => {
                    ctx.fillStyle = p.color; ctx.globalAlpha = p.life/500;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                });
                ctx.globalAlpha = 1;

                // Floating Text
                this.floatingTexts.forEach(t => {
                    ctx.fillStyle = t.color; ctx.font = 'bold 20px Jua';
                    ctx.fillText(t.text, t.x, t.y);
                });
            }

            spawnEnemy() {
                let x, y;
                if(Math.random()<0.5) {
                    x = Math.random()<0.5 ? -30 : canvas.width+30; y = Math.random()*canvas.height;
                } else {
                    x = Math.random()*canvas.width; y = Math.random()<0.5 ? -30 : canvas.height+30;
                }
                
                const seconds = this.gameTime / 1000;
                
                // ê¸°ë³¸ ì²´ë ¥ 30
                // 4ë¶„(240ì´ˆ)ê¹Œì§€ëŠ” ì‹œê°„ë‹¹ ì²´ë ¥ ì¦ê°€ ê±°ì˜ ì—†ìŒ (ë§¤ìš° ë¯¸ë¯¸)
                // 4ë¶„ ì´í›„ë¶€í„° ì²´ë ¥ ì¦ê°€ ì‹œì‘
                
                let timeHpBonus = 0;
                if (seconds > 240) {
                    timeHpBonus = (seconds - 240) * 0.5; // 4ë¶„ ì´í›„ 2ì´ˆë‹¹ 1 ì¦ê°€
                }
                
                // ë ˆë²¨ì— ë”°ë¥¸ ì²´ë ¥ ì¦ê°€ (ì‚¬ìš©ìê°€ ê°•í•´ì§„ ë§Œí¼ ì ë„ ê°•í•´ì§)
                const levelHpBonus = this.player.level * 5; 

                const hp = 30 + levelHpBonus + timeHpBonus;
                
                // ì†ë„: 4ë¶„ê¹Œì§€ëŠ” ëŠë¦¼(1.0~1.5), ê·¸ ì´í›„ ì ì°¨ ë¹¨ë¼ì§
                let baseSpeed = 1.0;
                if (seconds > 240) baseSpeed += (seconds - 240) * 0.005;
                
                const speed = Math.min(4.0, baseSpeed + Math.random() * 0.5);

                // ì  í¬ê¸° 2ë°° (radius 25 -> 50)
                this.enemies.push({ x, y, hp, maxHp: hp, radius: 50, speed: speed });
            }

            fireBullet() {
                if(this.enemies.length===0) return;
                // ê°€ê¹Œìš´ ì 
                let target = this.enemies.reduce((a, b) => {
                    let distA = Math.hypot(a.x-this.player.x, a.y-this.player.y);
                    let distB = Math.hypot(b.x-this.player.x, b.y-this.player.y);
                    return distA < distB ? a : b;
                });

                const angle = Math.atan2(target.y - this.player.y, target.x - this.player.x);
                const count = this.player.projectileCount;
                const spread = 0.2;
                const startAngle = angle - (spread*(count-1))/2;

                for(let i=0; i<count; i++){
                    let th = startAngle + spread*i;
                    this.bullets.push({ x: this.player.x, y: this.player.y, vx: Math.cos(th)*12, vy: Math.sin(th)*12 });
                }
                document.getElementById('sfx-shoot').currentTime=0;
                document.getElementById('sfx-shoot').play().catch(()=>{});
            }

            killEnemy(idx) {
                const e = this.enemies[idx];
                for(let i=0; i<5; i++) this.particles.push({
                    x:e.x, y:e.y, vx:(Math.random()-0.5)*5, vy:(Math.random()-0.5)*5,
                    life:300, color:'red', size:3
                });
                this.enemies.splice(idx, 1);
                this.gold += 10;
                this.updateHUD();
            }

            showDamage(x, y, txt) {
                this.floatingTexts.push({ x, y, text: txt, life: 40, color: '#fff' });
            }

            updateHUD() {
                document.getElementById('hpBar').style.width = `${Math.max(0, this.player.hp)}%`;
                document.getElementById('hpText').innerText = `HP ${Math.ceil(this.player.hp)}/${this.player.maxHp}`;
                document.getElementById('goldDisplay').innerText = this.gold;

                // ë‚œì´ë„ í‘œì‹œ
                const sec = this.gameTime / 1000;
                let diffText = "í‰í™”";
                let diffColor = "#4fd1c5"; // green
                if (sec > 240) { diffText = "ê¸´ì¥"; diffColor = "#f6ad55"; } // orange
                if (sec > 480) { diffText = "ìœ„ê¸°"; diffColor = "#f56565"; } // red
                
                const diffEl = document.getElementById('diff-display');
                diffEl.innerText = diffText;
                diffEl.style.color = diffColor;

                // ì‹œê°„ í‘œì‹œ
                document.getElementById('timer-display').innerText = this.formatTime(this.gameTime);
                document.getElementById('max-time').innerText = this.formatTime(Math.max(this.gameTime, this.maxTime));

                // ëŠ¥ë ¥ì¹˜ í‘œì‹œ
                document.getElementById('stat-dmg').innerText = this.player.damage;
                document.getElementById('stat-spd').innerText = (1000 / this.player.fireRate).toFixed(2);
                document.getElementById('stat-cnt').innerText = this.player.projectileCount;
                document.getElementById('enemy-dmg').innerText = "0.5"; // í˜„ì¬ ê³ ì • ë°ë¯¸ì§€

                // í•™ìŠµ í†µê³„ í‘œì‹œ
                document.getElementById('stat-total-problems').innerText = this.stats.totalProblems;
                document.getElementById('stat-attempts').innerText = this.stats.attempts;
                document.getElementById('stat-correct').innerText = this.stats.correct;
                document.getElementById('stat-wrong').innerText = this.stats.wrong;
                document.getElementById('stat-combo').innerText = this.stats.combo;
                document.getElementById('stat-max-combo').innerText = this.stats.maxCombo;
                
                let acc = 0;
                if (this.stats.attempts > 0) {
                    acc = ((this.stats.correct / this.stats.attempts) * 100).toFixed(1);
                }
                document.getElementById('stat-accuracy').innerText = `${acc}%`;
            }

            updateSkillDock() {
                document.getElementById('cnt-bomb').innerText = this.skills.bomb;
                document.getElementById('cnt-heal').innerText = this.skills.heal;
                document.getElementById('cnt-shield').innerText = this.skills.shield;
                document.querySelectorAll('.skill-slot')[0].classList.toggle('empty', this.skills.bomb<=0);
                document.querySelectorAll('.skill-slot')[1].classList.toggle('empty', this.skills.heal<=0);
                document.querySelectorAll('.skill-slot')[2].classList.toggle('empty', this.skills.shield<=0);
            }

            toggleShop() {
                const modal = document.getElementById('shop-modal');
                if(modal.style.display==='flex') {
                    modal.style.display='none';
                    this.lastTime = performance.now();
                    this.state='playing';
                    this.loop(this.lastTime);
            } else {
                    modal.style.display='flex';
                    this.state='paused';
                    document.getElementById('shop-gold').innerText=this.gold;
                }
            }
            
            gameOver() {
                this.state = 'gameover';
                document.getElementById('sfx-over').play().catch(()=>{});
                
                // ìµœê³  ê¸°ë¡ ê°±ì‹  (ì‹œê°„)
                if (this.gameTime > this.maxTime) {
                    this.maxTime = this.gameTime;
                    localStorage.setItem('mathMaxTime', this.maxTime);
                }

                // ë­í‚¹ ì „ì†¡
                sendRanking();
                
                // ì£½ì—ˆìœ¼ë¯€ë¡œ ì €ì¥ëœ ì´ì–´í•˜ê¸° ë°ì´í„° ì‚­ì œ
                localStorage.removeItem('mathSaveData');

                alert(`ê²Œì„ ì˜¤ë²„!\nìƒì¡´ ì‹œê°„: ${this.formatTime(this.gameTime)}`);
                location.reload();
            }

            saveGame() {
                if (this.state !== 'playing' && this.state !== 'paused') return;
                
                const saveData = {
                    gameTime: this.gameTime,
                    player: this.player,
                    gold: this.gold,
                    skills: this.skills,
                    stats: this.stats,
                    spawnRate: this.spawnRate,
                    // ì ë“¤ ìœ„ì¹˜ê¹Œì§€ ì €ì¥í•˜ë©´ ì¢‹ì§€ë§Œ ë„ˆë¬´ ë§ìœ¼ë¯€ë¡œ ìƒëµí•˜ê±°ë‚˜ ê°„ëµíˆ ì €ì¥
                    // ì—¬ê¸°ì„œëŠ” ì  ì •ë³´ëŠ” ì´ˆê¸°í™”í•˜ê³  ë‚œì´ë„(ì‹œê°„)ë§Œ ìœ ì§€í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ íƒ€í˜‘í•  ìˆ˜ë„ ìˆì§€ë§Œ,
                    // ì •í™•í•œ ë³µêµ¬ë¥¼ ìœ„í•´ ì  ì •ë³´ë„ ì¼ë¶€ ì €ì¥
                    // ë‹¤ë§Œ ì ì´ ë„ˆë¬´ ë§ìœ¼ë©´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ìš©ëŸ‰ ì´ìŠˆê°€ ìˆì„ ìˆ˜ ìˆìŒ (í…ìŠ¤íŠ¸ë¼ ê´œì°®ì„ ë“¯)
                    level: this.player.level
                };
                localStorage.setItem('mathSaveData', JSON.stringify(saveData));
            }

            loadGame() {
                const json = localStorage.getItem('mathSaveData');
                if (!json) return false;
                
                try {
                    const data = JSON.parse(json);
                    this.gameTime = data.gameTime || 0;
                    
                    // í”Œë ˆì´ì–´ ìŠ¤íƒ¯ ë³µêµ¬
                    Object.assign(this.player, data.player);
                    this.gold = data.gold;
                    this.skills = data.skills;
                    Object.assign(this.stats, data.stats);
                    this.spawnRate = data.spawnRate;
                    
                    // HUD ê°±ì‹ 
                    this.updateHUD();
                    this.updateSkillDock();
                    
                    // ë¬¸ì œ í…ìŠ¤íŠ¸ ê°±ì‹  (ë§ˆì§€ë§‰ ë ˆë²¨ ê¸°ì¤€ ë¬¸ì œ ì¬ìƒì„±)
                    this.nextProblem();
                    
                    return true;
                } catch (e) {
                    console.error("Save file corrupted", e);
                    return false;
                }
            }
        }

        // === ê²Œì„ ì¸ìŠ¤í„´ìŠ¤ ===
        let game = new Game();

        function startGame() {
            game.start();
        }

        // === UI ì¸í„°ë™ì…˜ ===
        function checkEnter(e) {
            if(e.key === 'Enter') submitAnswer();
        }

        function submitAnswer() {
            const input = document.getElementById('answer-input');
            const val = parseInt(input.value);
            
            if (isNaN(val)) {
                showToast("ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            game.stats.attempts++;

            if (val === currentProblem.answer) {
                showToast("ì •ë‹µ! ì—…ê·¸ë ˆì´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
                document.getElementById('sfx-level').play().catch(()=>{});
                
                // í†µê³„ ê°±ì‹ 
                game.stats.correct++;
                game.stats.combo++;
                if(game.stats.combo > game.stats.maxCombo) game.stats.maxCombo = game.stats.combo;
                
                game.updateHUD();
                
                // ì—…ê·¸ë ˆì´ë“œ ëª¨ë“œë¡œ ì „í™˜
                const quizArea = document.getElementById('quiz-container');
                const upgradeArea = document.getElementById('upgrade-container');
                quizArea.style.display = 'none';
                upgradeArea.style.display = 'flex';
                upgradeArea.innerHTML = '';

                // ì—…ê·¸ë ˆì´ë“œ ì˜µì…˜ ìƒì„±
                const opts = [
                    { name: 'ê³µê²©ë ¥ +10', apply: () => game.player.damage += 10 },
                    { name: 'HP íšŒë³µ & ìµœëŒ€ +50', apply: () => { game.player.maxHp+=50; game.player.hp=game.player.maxHp; } },
                    { name: 'ì—°ì‚¬ë ¥ +15%', apply: () => game.player.fireRate *= 0.85 },
                    { name: 'ë‹¤ì¤‘ ì‚¬ê²© +1', apply: () => game.player.projectileCount++ }
                ];
                
                opts.forEach(opt => {
                    let div = document.createElement('div');
                    div.className = 'upgrade-card';
                    div.innerHTML = `<div class="upgrade-title">${opt.name}</div>`;
                    div.onclick = () => {
                        opt.apply();
                        showToast("ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ!");
                        game.player.level++;
                        game.nextProblem();
                    };
                    upgradeArea.appendChild(div);
                });

            } else {
                showToast("ì˜¤ë‹µì…ë‹ˆë‹¤! ë‹¤ì‹œ í’€ì–´ë³´ì„¸ìš”.");
                game.stats.combo = 0; // ì½¤ë³´ ì´ˆê¸°í™”
                game.stats.wrong++;
                game.updateHUD();
                
                input.value = '';
                input.focus();
                // íŒ¨ë„í‹°: ì ë“¤ íšŒë³µ
                game.enemies.forEach(e => e.hp = e.maxHp);
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(()=> t.style.opacity=0, 2000);
        }

        // ìŠ¤í‚¬ ë° í¬ì»¤ìŠ¤ ê´€ë¦¬
        const inputField = document.getElementById('answer-input');
        inputField.addEventListener('focus', () => isInputFocused = true);
        inputField.addEventListener('blur', () => isInputFocused = false);

        document.addEventListener('keydown', (e) => {
            if (isInputFocused) return; // ì…ë ¥ ì¤‘ì¼ ë• ë‹¨ì¶•í‚¤ ë¬´ì‹œ
            if (e.key === '1') useSkill('bomb');
            if (e.key === '2') useSkill('heal');
            if (e.key === '3') useSkill('shield');
        });

        function buySkill(type, cost) {
            if(game.gold >= cost) {
                game.gold -= cost;
                game.skills[type]++;
                game.updateHUD();
                game.updateSkillDock();
                document.getElementById('shop-gold').innerText = game.gold;
                        } else {
                alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            }
        }

        function useSkill(type) {
            if(game.state !== 'playing') return;
            if(game.skills[type] > 0) {
                game.skills[type]--;
                game.updateSkillDock();
                
                if(type==='bomb') {
                    game.enemies = [];
                    document.getElementById('sfx-hit').play().catch(()=>{});
                } else if(type==='heal') {
                    game.player.hp = game.player.maxHp;
                    game.updateHUD();
                } else if(type==='shield') {
                    game.isInvincible = true;
                    setTimeout(()=>game.isInvincible=false, 5000);
                }
            }
        }

        

    </script>




    <!-- ë²„ì „ ì •ë³´ ì›Œí„°ë§ˆí¬ -->
    <div style="
        position: fixed;
        bottom: 5px;
        right: 10px;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.3);
        pointer-events: none;
        z-index: 9999;
        text-align: right;
        font-family: sans-serif;
    ">
        the-hero-robot-invasion<br>
        made by gametudyssam 0.009
    </div>

</body>
</html>
