<!DOCTYPE html>
<html lang="ko">
 <head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í‰ê· ì˜ ìˆ˜í˜¸ì: ë§¤ìŠ¤ ì„œë°”ì´ë²„</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-drag: none;
            touch-action: manipulation; /* í„°ì¹˜ ìµœì í™” */
        }

        /* ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €(íŠ¹íˆ Android Chrome)ì—ì„œ 100vhê°€ ì£¼ì†Œì°½/íˆ´ë°”ë¡œ ì¸í•´ ì˜ë¦¬ëŠ” ë¬¸ì œ ë°©ì§€ */
        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #1a202c;
            font-family: 'Jua', sans-serif;
            color: white;
            display: flex;
            width: 100vw;
            /* JSì—ì„œ --app-heightë¥¼ window.innerHeightë¡œ ê°±ì‹  (fallback: 100dvh/100vh) */
            height: var(--app-height, 100dvh);
            min-height: var(--app-height, 100dvh);
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ ì²˜ë¦¬ */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                /* flex ìì‹ì´ ë‚´ë¶€ì—ì„œ ìŠ¤í¬ë¡¤/ë¦¬ì‚¬ì´ì¦ˆë  ìˆ˜ ìˆë„ë¡ */
                min-height: 0;
            }
            #game-area {
                height: 60% !important;
                width: 100% !important;
                min-height: 0;
            }
            #sidebar {
                height: 40% !important;
                width: 100% !important;
                min-width: 0 !important;
                border-left: none !important;
                border-top: 4px solid #4a5568;
                padding: 10px !important;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                min-height: 0;
            }
            /* ëª¨ë°”ì¼ì—ì„œ í°íŠ¸ í¬ê¸° ì¡°ì • */
            .problem-box { font-size: 1rem !important; padding: 10px !important; margin-bottom: 10px !important; }
            .answer-input { padding: 10px !important; font-size: 1.2rem !important; }
            .submit-btn { padding: 10px !important; font-size: 1.1rem !important; }
            
            /* ëª¨ë°”ì¼ì—ì„œ UI ìœ„ì¹˜ ì¡°ì • */
            .rank-button { right: 90px !important; bottom: calc(15px + env(safe-area-inset-bottom)) !important; width: 60px !important; height: 60px !important; font-size: 0.8rem !important; }
            .shop-button { right: 15px !important; bottom: calc(15px + env(safe-area-inset-bottom)) !important; width: 60px !important; height: 60px !important; }
            .train-button { right: 15px !important; bottom: calc(90px + env(safe-area-inset-bottom)) !important; width: 60px !important; height: 60px !important; font-size: 0.9rem !important; }
            
            /* ëª¨ë°”ì¼ í†µê³„ íŒ¨ë„ ê°„ì†Œí™” ë˜ëŠ” í°íŠ¸ ì¶•ì†Œ */
            .math-stats { font-size: 0.8rem !important; padding: 8px !important; }
            .stat-row { font-size: 0.8rem !important; margin-bottom: 2px !important; }
            
            .skill-dock { bottom: calc(15px + env(safe-area-inset-bottom)) !important; gap: 10px !important; }
            .skill-slot { width: 50px !important; height: 50px !important; }
            .skill-slot span { font-size: 18px !important; }
        }

        /* === ì¢Œì¸¡ ê²Œì„ ì˜ì—­ === */
        #game-area {
            position: relative;
            flex-grow: 1;
            height: 100%;
            overflow: hidden;
            min-height: 0;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        /* UI ì˜¤ë²„ë ˆì´ (ì²´ë ¥, ê³¨ë“œ, ìŠ¤í‚¬ ë“±) */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* ìƒë‹¨ ìƒíƒœë°” */
        .hud-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: auto;
        }

        .status-bar {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 280px;
        }

        .bar-container {
            width: 100%;
            height: 22px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 11px;
            border: 2px solid #555;
            position: relative;
            overflow: hidden;
        }

        .hp-bar-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff4b1f, #ff9068); transition: width 0.2s; }
        .exp-bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #11998e, #38ef7d); transition: width 0.2s; }
        
        .bar-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 13px; text-shadow: 1px 1px 2px black; white-space: nowrap;
        }

        .currency-display {
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 20px;
            border-radius: 20px;
            border: 2px solid gold;
            color: gold;
            font-size: 1.4rem;
            display: flex; align-items: center; gap: 10px;
        }

        /* í•˜ë‹¨ ìŠ¤í‚¬ ìŠ¬ë¡¯ */
        .skill-dock {
            position: absolute;
            bottom: calc(20px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }

        .skill-slot {
            width: 70px; height: 70px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #777;
            border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.1s;
        }
        .skill-slot:active { transform: scale(0.95); }
        .skill-slot.active { border-color: #00ff00; box-shadow: 0 0 15px #00ff00; }
        .skill-slot.empty { opacity: 0.5; cursor: default; }

        .skill-count { position: absolute; bottom: 2px; right: 6px; font-size: 16px; color: white; }
        .skill-key { position: absolute; top: 2px; left: 6px; font-size: 11px; color: #aaa; }

        /* ìƒíƒœë°” í™•ì¥ */
        .stats-panel {
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 10px;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        /* í•™ìŠµ í†µê³„ ìŠ¤íƒ€ì¼ */
        .math-stats {
            background: #1a202c;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #4a5568;
            margin-bottom: 10px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.95rem;
            color: #cbd5e0;
        }
        .stat-row:last-child { margin-bottom: 0; }

        /* ìƒì  ë²„íŠ¼ */
        .shop-button {
            position: absolute; bottom: calc(20px + env(safe-area-inset-bottom)); right: calc(20px + env(safe-area-inset-right));
            background: linear-gradient(135deg, #ff9966, #ff5e62);
            border: none; border-radius: 50%; width: 70px; height: 70px;
            color: white; font-size: 1rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); pointer-events: auto;
        }

        /* === ìš°ì¸¡ ì‚¬ì´ë“œë°” (ë¬¸ì œ ì˜ì—­) === */
        #sidebar {
            width: 380px;
            min-width: 380px;
            background: #2d3748;
            border-left: 4px solid #4a5568;
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            /* ëª¨ë°”ì¼ì—ì„œ ë‚´ìš©ì´ ê¸¸ì–´ì§ˆ ë•Œ ì˜ë¦¼ ë°©ì§€(PCì—ì„œë„ ìŠ¤í¬ë¡¤ ê°€ëŠ¥) */
            overflow-y: auto;
            min-height: 0;
        }

        .sidebar-header {
            font-size: 1.5rem;
            color: #4fd1c5;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #4a5568;
            padding-bottom: 10px;
        }

        /* ë¬¸ì œ í‘œì‹œ ì˜ì—­ */
        #quiz-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .problem-box {
            background: #1a202c;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.3rem;
            line-height: 1.6;
        color: #e2e8f0;
            white-space: pre-line;
            border: 2px solid #4a5568;
        }

        .input-group {
            margin-bottom: 20px;
        }
        
        .answer-input {
            width: 100%;
            padding: 15px;
            font-size: 1.5rem;
            border: 3px solid #4fd1c5;
            border-radius: 10px;
            background: #1a202c;
            color: white;
            font-family: 'Jua', sans-serif;
            text-align: center;
            margin-bottom: 10px;
            user-select: auto; /* ì…ë ¥ í—ˆìš© */
        }
        
        /* type=number í™”ì‚´í‘œ ì œê±° */
        .answer-input::-webkit-outer-spin-button,
        .answer-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.3rem;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .submit-btn:active { transform: scale(0.98); }

        /* ì—…ê·¸ë ˆì´ë“œ ì„ íƒ ëª¨ë“œ */
        #upgrade-container {
            display: none;
                flex-direction: column;
                gap: 10px;
            }
            
        .upgrade-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
                padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, border 0.2s;
            border: 2px solid transparent;
            text-align: center;
        }
        .upgrade-card:hover { transform: translateY(-3px); border-color: white; }
        .upgrade-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 5px; }
        .upgrade-desc { font-size: 1rem; opacity: 0.9; }

        /* ì•Œë¦¼ ë©”ì‹œì§€ */
        .toast {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            z-index: 2000;
            white-space: nowrap;
        }

        /* ì‹œì‘ í™”ë©´ */
        #start-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a202c, #2d3748);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 3000;
        }
        .start-btn {
            padding: 15px 50px; font-size: 2rem;
            background: linear-gradient(90deg, #f6d365, #fda085);
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 10px 20px rgba(253, 160, 133, 0.4);
            font-family: 'Jua', sans-serif;
        }

        /* ìƒì  ëª¨ë‹¬ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 2500;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #2d3748; border: 4px solid gold;
            border-radius: 20px; padding: 30px; width: 500px; text-align: center;
        }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .shop-item { background: #1a202c; padding: 15px; border-radius: 10px; cursor: pointer; border: 1px solid #555; }
        .shop-item:hover { border-color: gold; }

        /* ë­í‚¹ ë²„íŠ¼ - ìƒì  ë²„íŠ¼ ì™¼ìª½ */
        .rank-button {
            position: absolute;
            bottom: calc(20px + env(safe-area-inset-bottom));
            right: calc(110px + env(safe-area-inset-right)); /* ìƒì  ë²„íŠ¼ ì˜† */
            background: linear-gradient(135deg, #a18cd1, #fbc2eb);
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            pointer-events: auto;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* ë­í‚¹ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .rank-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #e2e8f0;
        }
        .rank-table th, .rank-table td {
            padding: 10px;
            border-bottom: 1px solid #4a5568;
            text-align: center;
        }
        .rank-table th {
            background: #2d3748;
            color: #4fd1c5;
        }
        .my-rank {
            background: linear-gradient(90deg, rgba(79, 209, 197, 0.3), rgba(79, 209, 197, 0.1));
            border-left: 4px solid #4fd1c5;
            font-weight: bold;
            color: #fff;
            box-shadow: 0 2px 8px rgba(79, 209, 197, 0.3);
        }

        /* ë­í‚¹ ê¸°ì¤€ ì»¬ëŸ¼ ìŒì˜ í‘œì‹œ */
        .highlight-col {
            background: rgba(255, 215, 0, 0.1);
            font-weight: bold;
            color: #ffd700;
        }

        /* ë‹‰ë„¤ì„ ì…ë ¥ ëª¨ë‹¬ */
        #name-modal {
            z-index: 3500;
        }
        .name-input {
            width: 80%;
            padding: 10px;
            font-size: 1.2rem;
            border-radius: 5px;
            border: 2px solid #4a5568;
            background: #1a202c;
            color: white;
            margin: 20px 0;
            text-align: center;
        }

    </style>
</head>
 <body>

    <!-- ì¢Œì¸¡ ê²Œì„ ì˜ì—­ -->
    <div id="game-area">
        <canvas id="gameCanvas"></canvas>
        
        <div id="ui-layer">
            <div class="hud-top">
                <div class="status-bar">
                    <div class="bar-container">
                        <div class="hp-bar-fill" id="hpBar"></div>
                        <div class="bar-text" id="hpText">HP 100/100</div>
                    </div>
                    <!-- ìƒì„¸ ìŠ¤íƒ¯ íŒ¨ë„ ì¶”ê°€ -->
                    <div class="stats-panel">
                        <div>ë‹‰ë„¤ì„: <span id="user-nickname" style="color:#4fd1c5">ì•Œ ìˆ˜ ì—†ìŒ</span></div>
                        <div>ë‚œì´ë„: <span id="diff-display" style="color:#4fd1c5">í‰í™”</span></div>
                        <div style="font-size: 0.8rem; margin-top:5px; color:#aaa;">
                            âš”ï¸ ë‚´ ê³µê²©ë ¥: <span id="stat-dmg">25</span> <br>
                            âš¡ ì—°ì‚¬ì†ë„: <span id="stat-spd">1.25</span>/s <br>
                            ğŸ¹ ë°œì‚¬ì²´ìˆ˜: <span id="stat-cnt">1</span> <br>
                            ğŸ‘¾ ì  ê³µê²©ë ¥: <span id="enemy-dmg" style="color:#f56565">0.5</span> <br>
                            â³ ìµœì¥ìƒì¡´: <span id="max-time" style="color:#ffd700">00:00</span>
                        </div>
                    </div>
                </div>
                <div class="currency-display">
                    <span>ğŸ’°</span><span id="goldDisplay">0</span>
                </div>
            </div>
            
            <!-- ì¤‘ì•™ ìƒë‹¨ íƒ€ì´ë¨¸ ë° ë‹‰ë„¤ì„ ì¶”ê°€ -->
            <div id="timer-display" style="position:absolute; top:15px; left:50%; transform:translateX(-50%); font-size:2rem; font-weight:bold; text-shadow:0 0 5px black; pointer-events:none;">
                00:00
            </div>
            <div id="nickname-display" style="position:absolute; top:50px; left:50%; transform:translateX(-50%); font-size:1.2rem; font-weight:bold; color:#4fd1c5; text-shadow:0 0 3px black; pointer-events:none;">
                ë‹‰ë„¤ì„: ì•Œ ìˆ˜ ì—†ìŒ
            </div>

            <div class="skill-dock" id="skillDock">
                <div class="skill-slot empty" onclick="useSkill('bomb')">
                    <span style="font-size:24px">ğŸ’£</span><span class="skill-count" id="cnt-bomb">0</span><span class="skill-key">1</span>
                </div>
                <div class="skill-slot empty" onclick="useSkill('heal')">
                    <span style="font-size:24px">â¤ï¸</span><span class="skill-count" id="cnt-heal">0</span><span class="skill-key">2</span>
                </div>
                <div class="skill-slot empty" onclick="useSkill('shield')">
                    <span style="font-size:24px">ğŸ›¡ï¸</span><span class="skill-count" id="cnt-shield">0</span><span class="skill-key">3</span>
                </div>
            </div>

            <button class="rank-button" onclick="openRankingModal()">ğŸ† ë­í‚¹</button>
            <button class="shop-button" onclick="game.toggleShop()">ìƒì </button>
        </div>
    </div>

    <!-- ìš°ì¸¡ ì‚¬ì´ë“œë°” (ë¬¸ì œ ì˜ì—­) -->
    <div id="sidebar">
        <div class="sidebar-header">ë¡œë´‡ ê³µê²© ë°©ì–´ ì§€ì›ì‹¤</div>
        
        <!-- í•™ìŠµ í†µê³„ íŒ¨ë„ ì¶”ê°€ -->
        <div class="math-stats">
            <div class="stat-row"><span>ğŸ”¢ ì´ ë¬¸ì œ ìˆ˜ (ëˆ„ì )</span><span id="stat-total-problems">0</span></div>
            <div class="stat-row"><span>âœï¸ ì´ í’€ì´ ì‹œë„ (ëˆ„ì )</span><span id="stat-attempts">0</span></div>
            <div class="stat-row"><span>â­• ì´ ì •ë‹µ (ëˆ„ì )</span><span id="stat-correct">0</span></div>
            <div class="stat-row"><span>âŒ ì´ ì˜¤ë‹µ (ëˆ„ì )</span><span id="stat-wrong">0</span></div>
            <div class="stat-row"><span>ğŸ”¥ í˜„ì¬ ê²Œì„ ì—°ì† ì •ë‹µ</span><span id="stat-combo" style="color:#f6ad55">0</span></div>
            <div class="stat-row"><span>ğŸ† ì—­ëŒ€ ìµœê³  ì—°ì† ì •ë‹µ</span><span id="stat-max-combo">0</span></div>
            <div class="stat-row"><span>ğŸ“Š ì •ë‹µë¥  (ëˆ„ì )</span><span id="stat-accuracy">0%</span></div>
        </div>

        <hr style="border: 0; border-top: 1px solid #4a5568; margin: 15px 0;">
        
        <!-- í€´ì¦ˆ ëª¨ë“œ -->
        <div id="quiz-container">
            <div class="problem-box" id="problem-text">
                ë¬¸ì œ ë¡œë”©ì¤‘...
        </div>
            <div class="input-group">
                <input type="number" id="answer-input" class="answer-input" placeholder="ì •ë‹µ ì…ë ¥" onkeydown="checkEnter(event)">
                <button class="submit-btn" onclick="submitAnswer()">ì œì¶œ</button>
                </div>
            <p style="font-size: 0.9rem; color: #aaa; text-align: center;">
                ì •ë‹µì„ ë§ì¶”ë©´ ìºë¦­í„°ë¥¼ ì—…ê·¸ë ˆì´ë“œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
            </p>
   </div>

        <!-- ì—…ê·¸ë ˆì´ë“œ ì„ íƒ ëª¨ë“œ -->
        <div id="upgrade-container">
            <div style="text-align:center; color:#4fd1c5; margin-bottom:10px;">ë³´ìƒì„ ì„ íƒí•˜ì„¸ìš”!</div>
            <!-- ë™ì  ìƒì„± -->
    </div>
   </div>
    
    <!-- ì‹œì‘ í™”ë©´ -->
    <div id="start-screen">
        <h1 style="font-size: 3rem; color: #4fd1c5; text-shadow: 0 0 20px rgba(79,209,197,0.5); margin-bottom: 20px;">
            ìš°ì£¼ì˜ ìˆ˜í˜¸ì: Average-Hero
        </h1>
        <p style="color: #cbd5e0; font-size: 1.2rem; margin-bottom: 40px; text-align: center; line-height: 1.6;">
            ì¢Œì¸¡ì—ì„œëŠ” ì „íˆ¬ê°€, ìš°ì¸¡ì—ì„œëŠ” ìˆ˜í•™ ë¬¸ì œê°€ ì§„í–‰ë©ë‹ˆë‹¤.<br>
            ë¬¸ì œë¥¼ í’€ì–´ ìºë¦­í„°ë¥¼ ì„±ì¥ì‹œí‚¤ê³  ì ì„ ë§‰ì•„ë‚´ì„¸ìš”!
        </p>
        <button class="start-btn" onclick="checkNameAndStart()">ì‘ì „ ê°œì‹œ</button>
    </div>

    <!-- ìƒì  ëª¨ë‹¬ -->
    <div id="shop-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="color: gold; margin-top: 0;">ë³´ê¸‰ ìƒì </h2>
            <p>ë³´ìœ  ê³¨ë“œ: <span id="shop-gold">0</span></p>
            <div class="shop-grid">
                <div class="shop-item" onclick="buySkill('bomb', 100)">
                    <div style="font-size: 30px;">ğŸ’£</div><div>ì „ë©¸ í­íƒ„</div><div style="color:gold">100G</div>
            </div>
                <div class="shop-item" onclick="buySkill('heal', 50)">
                    <div style="font-size: 30px;">â¤ï¸</div><div>ê¸´ê¸‰ íšŒë³µ</div><div style="color:gold">50G</div>
        </div>
                <div class="shop-item" onclick="buySkill('shield', 150)">
                    <div style="font-size: 30px;">ğŸ›¡ï¸</div><div>ë¬´ì  ë°©íŒ¨</div><div style="color:gold">150G</div>
    </div>
            </div>
            <button onclick="game.toggleShop()" style="margin-top: 20px; padding: 10px 30px; background: #4a5568; border:none; color:white; border-radius: 5px; cursor:pointer;">ë‹«ê¸°</button>
    </div>
  </div>

    <!-- ë­í‚¹ ëª¨ë‹¬ -->
    <div id="rank-modal" class="modal-overlay">
        <div class="modal-content" style="width: 600px; max-height: 80vh; overflow-y: auto;">
            <h2 style="color: #a18cd1; margin-top: 0;">ğŸ† ê¸€ë¡œë²Œ ë­í‚¹</h2>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px; text-align: center;">ì •ë‹µë¥  ë­í‚¹ì€ 100ë¬¸ì œ ì´ìƒ í‘¼ ì‚¬ëŒë§Œ ê¸°ë¡ë©ë‹ˆë‹¤.</p>

            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
                <button onclick="loadRanking('problems')" class="shop-item" style="padding:5px 15px; color:white;">í‘¼ ë¬¸ì œê°œìˆ˜ìˆœ</button>
                <button onclick="loadRanking('combo')" class="shop-item" style="padding:5px 15px; color:white;">ì—°ì†ì •ë‹µìˆœ</button>
                <button onclick="loadRanking('survival')" class="shop-item" style="padding:5px 15px; color:white;">ìƒì¡´ì‹œê°„ìˆœ</button>
                <button onclick="loadRanking('accuracy')" class="shop-item" style="padding:5px 15px; color:white;">ì •ë‹µë¥ ìˆœ</button>
            </div>

            <div id="rank-list-container">ë¡œë”©ì¤‘...</div>
            
            <button onclick="document.getElementById('rank-modal').style.display='none'" style="margin-top: 20px; padding: 10px 30px; background: #4a5568; border:none; color:white; border-radius: 5px; cursor:pointer;">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ë‹‰ë„¤ì„ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="name-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content" style="width: 400px;">
            <h2 style="color: #4fd1c5; margin-top: 0;">ìš”ì› ë“±ë¡</h2>
            <p>ë­í‚¹ì— ë“±ë¡ë  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="text" id="username-input" class="name-input" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 8ê¸€ì)" maxlength="8">
            <button onclick="submitName()" class="start-btn" style="font-size:1.2rem; padding:10px 30px;">í™•ì¸</button>
        </div>
    </div>

    <div id="toast" class="toast">ë©”ì‹œì§€</div>

    <!-- ì˜¤ë””ì˜¤ -->
    <audio id="bgm" loop><source src="berserk.mp3" type="audio/mp3"></audio>
    <audio id="sfx-shoot" src="swordattack.mp3"></audio>
    <audio id="sfx-hit" src="fireball-impact.mp3"></audio>
    <audio id="sfx-level" src="bonus-points-190035.mp3"></audio>
    <audio id="sfx-over" src="game-over-417465.mp3"></audio>

  <script>
        // === ëª¨ë°”ì¼ ë·°í¬íŠ¸ ë†’ì´ ë³´ì • (ì£¼ì†Œì°½/íˆ´ë°”ë¡œ ì¸í•œ 100vh ì˜ë¦¼ ë°©ì§€) ===
        (function setupAppHeight() {
            const docEl = document.documentElement;
            const setHeight = () => {
                const h = (window.visualViewport && window.visualViewport.height)
                    ? window.visualViewport.height
                    : window.innerHeight;
                docEl.style.setProperty('--app-height', `${Math.floor(h)}px`);
            };

            setHeight();
            window.addEventListener('resize', setHeight, { passive: true });
            window.addEventListener('orientationchange', setHeight, { passive: true });
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', setHeight, { passive: true });
                window.visualViewport.addEventListener('scroll', setHeight, { passive: true });
            }
        })();

        // === ë­í‚¹(ë¹„ì •ìƒ í”Œë ˆì´ ë°©ì§€) ìœ í‹¸ ===
        // ì°¸ê³ : multiplying-decimals-main/index.htmlì˜ "createSignature + LIMITS + validator" ìŠ¤íƒ€ì¼ì„ ê°„ì†Œí™”í•˜ì—¬ ì ìš©
        const RankingSecurity = (() => {
            // âš ï¸ ì›¹ í´ë¼ì´ì–¸íŠ¸ íŠ¹ì„±ìƒ ì™„ì „í•œ ë³´ì•ˆì€ ì„œë²„ ê²€ì¦ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.
            // ê·¸ë˜ë„ ë‹¨ìˆœ ê°’ ì¡°ì‘/ìŠ¤í¬ë¦½íŠ¸ í‚¤ë”” ìˆ˜ì¤€ì˜ ê³µê²©ì€ ëŒ€ë¶€ë¶„ ì°¨ë‹¨/ì–µì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            const CLIENT_VERSION = "avg-hero-anti-cheat-1";
            const SECRET_KEY = "avg_hero_ranking_prevention_key_2025"; // ì„œë²„ì—ì„œë„ ë™ì¼ í‚¤ë¡œ ê²€ì¦í•˜ë©´ íš¨ê³¼ ê·¹ëŒ€í™”

            // í•©ë¦¬ì  ìƒí•œ (ì •ìƒ ê³ ì¸ë¬¼ í”Œë ˆì´ë¥¼ ê³ ë ¤í•´ ë„‰ë„‰í•˜ê²Œ)
            const LIMITS = Object.freeze({
                MAX_NAME_LEN: 8,
                MAX_LEVEL: 100000,
                MAX_ATTEMPTS: 500000,
                MAX_CORRECT: 500000,
                MAX_COMBO: 500000,
                MAX_SURVIVAL_SEC: 172800, // 48ì‹œê°„
                // ì†ë„ ê¸°ë°˜ ì œí•œ (ë¬¼ë¦¬ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•œ ìˆ˜ì¤€ë§Œ ì°¨ë‹¨)
                MAX_ATTEMPTS_PER_SEC: 8,  // ì´ˆë‹¹ 8ë¬¸ì œ ì‹œë„(ë§¤ìš° ë„‰ë„‰)
                MIN_MS_PER_ATTEMPT: 200   // ì‹œë„ë‹¹ ìµœì†Œ 0.2ì´ˆ(ë§¤ìš° ë„‰ë„‰)
            });

            // ê°„ë‹¨ í•´ì‹œ(ì„œëª…) ìƒì„±: ì„œë²„ì™€ ë™ì¼ ë¡œì§ìœ¼ë¡œ ë§ì¶”ë©´ "ì„œëª… ê²€ì¦" ê°€ëŠ¥
            function createSignature(payload) {
                const raw = [
                    payload.username,
                    payload.level,
                    payload.problems,
                    payload.maxCombo,
                    payload.survivalTime,
                    payload.attempts,
                    payload.sessionId,
                    SECRET_KEY
                ].join("_");

                let hash = 0;
                for (let i = 0; i < raw.length; i++) {
                    hash = ((hash << 5) - hash) + raw.charCodeAt(i);
                    hash |= 0; // 32bit
                }
                return Math.abs(hash).toString(16);
            }

            function clampInt(n, min, max) {
                if (!Number.isFinite(n)) return min;
                n = Math.trunc(n);
                if (n < min) return min;
                if (n > max) return max;
                return n;
            }

            function sanitizeUsername(name) {
                const trimmed = String(name || "").trim();
                if (!trimmed) return "";
                // ê³µë°±/ì œì–´ë¬¸ì ì œê±° + ê¸¸ì´ ì œí•œ
                const cleaned = trimmed.replace(/[\u0000-\u001f\u007f\s]+/g, "").slice(0, LIMITS.MAX_NAME_LEN);
                // ë„ˆë¬´ ìœ„í—˜í•œ ë¬¸ìëŠ” ì œê±°(í‘œì‹œ/ë¡œê·¸ ê¹¨ì§ ë°©ì§€)
                return cleaned.replace(/[<>`"']/g, "");
            }

            function getOrCreateSessionId() {
                const key = "mathHeroSessionId";
                let existing = localStorage.getItem(key);
                if (!existing || typeof existing !== "string" || existing.length < 8) {
                    const bytes = new Uint8Array(16);
                    (crypto?.getRandomValues ? crypto.getRandomValues(bytes) : bytes.fill(Math.floor(Math.random() * 256)));
                    existing = Array.from(bytes).map(b => b.toString(16).padStart(2, "0")).join("");
                    localStorage.setItem(key, existing);
                }
                currentSessionId = existing; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                return existing;
            }

            function buildPayload(game, username) {
                const sessionId = getOrCreateSessionId();

                // ì›ë³¸ ìŠ¤íƒ¯ ìŠ¤ëƒ…ìƒ·
                const rawLevel = Number(game?.player?.level);
                const rawCorrect = Number(game?.stats?.correct);
                const rawMaxCombo = Number(game?.stats?.maxCombo);
                const rawAttempts = Number(game?.stats?.attempts);
                const rawSurvival = Number.isFinite(game?.gameTime) ? Math.floor(game.gameTime / 1000) : 0;

                const payload = {
                    username: sanitizeUsername(username),
                    level: clampInt(rawLevel, 1, LIMITS.MAX_LEVEL),
                    problems: clampInt(rawCorrect, 0, LIMITS.MAX_CORRECT),
                    maxCombo: clampInt(rawMaxCombo, 0, LIMITS.MAX_COMBO),
                    survivalTime: clampInt(rawSurvival, 0, LIMITS.MAX_SURVIVAL_SEC),
                    attempts: clampInt(rawAttempts, 0, LIMITS.MAX_ATTEMPTS),
                    sessionId,
                    clientVersion: 1, // ì§ì ‘ ìˆ«ì í• ë‹¹ (ì•ˆì „í•˜ê²Œ)
                    timestamp: new Date().toISOString()
                };

                // ì •í•©ì„± ë³´ì •
                if (payload.problems > payload.attempts) payload.problems = payload.attempts;
                if (payload.maxCombo > payload.problems) payload.maxCombo = payload.problems;

                payload.signature = createSignature(payload);
                return payload;
            }

            function isLikelyValid(payload) {
                if (!payload.username) return { ok: false, reason: "NO_NAME" };
                if (payload.username.length > LIMITS.MAX_NAME_LEN) return { ok: false, reason: "NAME_TOO_LONG" };
                if (payload.level < 1 || payload.level > LIMITS.MAX_LEVEL) return { ok: false, reason: "BAD_LEVEL" };
                if (payload.survivalTime < 0 || payload.survivalTime > LIMITS.MAX_SURVIVAL_SEC) return { ok: false, reason: "BAD_TIME" };
                if (payload.attempts < 0 || payload.attempts > LIMITS.MAX_ATTEMPTS) return { ok: false, reason: "BAD_ATTEMPTS" };
                if (payload.problems < 0 || payload.problems > payload.attempts) return { ok: false, reason: "BAD_CORRECT" };
                if (payload.maxCombo < 0 || payload.maxCombo > payload.problems) return { ok: false, reason: "BAD_COMBO" };

                // ì†ë„ ê¸°ë°˜ ë¹„ì •ìƒ ê°ì§€(ë§¤í¬ë¡œ/ìˆœê°„ì¹˜íŠ¸)
                const t = Math.max(1, payload.survivalTime);
                const attemptsPerSec = payload.attempts / t;
                if (attemptsPerSec > LIMITS.MAX_ATTEMPTS_PER_SEC) return { ok: false, reason: "TOO_FAST" };
                if (payload.attempts > 0 && (payload.survivalTime * 1000) < (payload.attempts * LIMITS.MIN_MS_PER_ATTEMPT)) {
                    return { ok: false, reason: "IMPOSSIBLE_SPEED" };
                }

                // ì„œëª… ì¼ì¹˜ í™•ì¸(í´ë¼ ë‚´ë¶€ ìœ„ë³€ì¡°/ì‹¤ìˆ˜ ë°©ì§€)
                const expected = createSignature(payload);
                if (payload.signature !== expected) return { ok: false, reason: "BAD_SIGNATURE" };
                return { ok: true };
            }

            // ê°„ë‹¨ ì „ì†¡ ë ˆì´íŠ¸ ë¦¬ë°‹(ë°˜ë³µ ì „ì†¡ ê³µê²© ì™„í™”)
            let lastSentAt = 0;
            function canSendNow() {
                const now = Date.now();
                if (now - lastSentAt < 1000) return false; // í…ŒìŠ¤íŠ¸ ìœ„í•´ 1ì´ˆë¡œ ë‹¨ì¶•
                lastSentAt = now;
                return true;
            }

            return Object.freeze({
                LIMITS,
                sanitizeUsername,
                buildPayload,
                isLikelyValid,
                canSendNow,
                getOrCreateSessionId // ì™¸ë¶€ ê³µê°œ ì¶”ê°€
            });
        })();

        // === ë­í‚¹ ì‹œìŠ¤í…œ ===
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyfChnGng4MsR5VIaRJSJvpx0q_bUIYSVJcxUQd9DJQkdTCEanB1Z6-XeIyVSldofq2/exec";
        let currentUser = "";
        let currentSessionId = "";

        // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬ í•¨ìˆ˜
        async function checkUsernameAvailability(username, sessionId) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3ì´ˆ íƒ€ì„ì•„ì›ƒ

                const checkUrl = `${APPS_SCRIPT_URL}?action=check_username&username=${encodeURIComponent(username)}&sessionId=${encodeURIComponent(sessionId)}`;
                console.log("Checking username availability:", checkUrl);

                const response = await fetch(checkUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                console.log("Username check response:", response.status, response.type);

                if (response.type === 'opaque') {
                    // no-cors ëª¨ë“œì—ì„œëŠ” ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìŒ - ì¼ë‹¨ í—ˆìš©
                    console.log("Opaque response - allowing username");
                    return true;
                }

                const result = await response.json();
                console.log("Username check result:", result);
                return result.available === true;
            } catch (err) {
                if (err.name === 'AbortError') {
                    console.log("Username check timed out - allowing username");
                } else {
                    console.error("ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬ ì‹¤íŒ¨:", err);
                }
                // íƒ€ì„ì•„ì›ƒ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì¼ë‹¨ í—ˆìš©
                return true;
            }
        }

        function checkNameAndStart() {
            const storedName = localStorage.getItem('mathHeroName');
            
            // ì„¸ì…˜ IDê°€ ì—†ìœ¼ë©´ ì§€ê¸ˆ ìƒì„± (ì¤‘ìš”!)
            RankingSecurity.getOrCreateSessionId(); 

            if (storedName) {
                // ì €ì¥ëœ ê°’ë„ ì •ì œ(ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë³€ì¡° ëŒ€ë¹„)
                currentUser = RankingSecurity.sanitizeUsername(storedName);
                if (!currentUser) {
                    localStorage.removeItem('mathHeroName');
                    document.getElementById('start-screen').style.display = 'none';
                    document.getElementById('name-modal').style.display = 'flex';
                    document.getElementById('username-input').focus();
                    return;
                }

                // ë‹‰ë„¤ì„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                const nicknameEl = document.getElementById('user-nickname');
                const nicknameDisplayEl = document.getElementById('nickname-display');

                if (nicknameEl) {
                    nicknameEl.innerText = currentUser;
                }
                if (nicknameDisplayEl) {
                    nicknameDisplayEl.innerText = `ë‹‰ë„¤ì„: ${currentUser}`;
                }
                
                // ì´ì–´í•˜ê¸° ë°ì´í„° í™•ì¸
                if (localStorage.getItem('mathSaveData')) {
                    if (confirm("ì €ì¥ëœ ê²Œì„ì´ ìˆìŠµë‹ˆë‹¤. ì´ì–´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        if (game.loadGame()) {
                            document.getElementById('start-screen').style.display = 'none';
                            // ì˜¤ë””ì˜¤ ì¤€ë¹„
                            const audioIds = ['bgm', 'sfx-shoot', 'sfx-hit', 'sfx-level', 'sfx-over'];
                            audioIds.forEach(id => { const a=document.getElementById(id); if(a) a.load(); });
                            
                            game.state = 'playing';
                            
                            // ì¤‘ìš”: ì‹œê°„ ê´€ë ¨ ë³€ìˆ˜ ì¬ì„¤ì •
                            const now = performance.now();
                            game.lastTime = now;
                            game.player.lastFire = now; // ì¦‰ì‹œ ë°œì‚¬ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
                            game.lastSpawn = now;       // ìŠ¤í° íƒ€ì´ë¨¸ë„ ë¦¬ì…‹

                            game.loop(now);
                            document.getElementById('bgm').play().catch(()=>{});
                            return;
                        }
                    } else {
                        // ì´ì–´í•˜ê¸° ì·¨ì†Œ ì‹œ ë°ì´í„° ì‚­ì œ
                        localStorage.removeItem('mathSaveData');
                    }
                }
                startGame();
            } else {
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('name-modal').style.display = 'flex';
                document.getElementById('username-input').focus();
            }
        }

        function submitName() {
            const input = document.getElementById('username-input');
            const name = input.value.trim();
            if (!name) {
                showToast("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }
            // ë‹‰ë„¤ì„ ì •ì œ(í‘œì‹œ/ì„œë²„ ë¡œê·¸/ë‹¨ìˆœ ê³µê²© ë°©ì§€)
            const candidateName = RankingSecurity.sanitizeUsername(name);
            if (!candidateName) {
                showToast("ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ì´ë¦„ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            // ì„¸ì…˜ ID ìƒì„±
            const sessionId = RankingSecurity.getOrCreateSessionId();

            // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬ (ì„œë²„ì— ë“±ë¡ëœ ì´ë¦„ì¸ì§€ í™•ì¸)
            checkUsernameAvailability(candidateName, sessionId).then(isAvailable => {
                if (!isAvailable) {
                    showToast("ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì´ë¦„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
                    return;
                }

                // ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¦„ì´ë©´ ì €ì¥
                currentUser = candidateName;
                localStorage.setItem('mathHeroName', currentUser);
                localStorage.setItem('mathHeroSessionId', sessionId); // ì„¸ì…˜ IDë„ ì €ì¥
                document.getElementById('name-modal').style.display = 'none';

                // ë‹‰ë„¤ì„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                const nicknameEl = document.getElementById('user-nickname');
                const nicknameDisplayEl = document.getElementById('nickname-display');

                if (nicknameEl) {
                    nicknameEl.innerText = currentUser;
                }
                if (nicknameDisplayEl) {
                    nicknameDisplayEl.innerText = `ë‹‰ë„¤ì„: ${currentUser}`;
                }

                startGame();
            }).catch(err => {
                console.error("ë‹‰ë„¤ì„ í™•ì¸ ì‹¤íŒ¨:", err);
                showToast("ë‹‰ë„¤ì„ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            });
        }

        async function sendRanking() {
            console.log("ğŸ” sendRanking í•¨ìˆ˜ í˜¸ì¶œë¨");

            if (!currentUser) {
                console.log("âŒ ë­í‚¹ ì „ì†¡ ì¤‘ë‹¨: ì‚¬ìš©ì ì—†ìŒ");
                return;
            }
            console.log("ğŸ‘¤ ì‚¬ìš©ì í™•ì¸:", currentUser);

            if (!RankingSecurity.canSendNow()) {
                console.log("âŒ ë­í‚¹ ì „ì†¡ ì¤‘ë‹¨: ìŠ¤íŒ¸ ë°©ì§€ (ì¿¨ë‹¤ìš´ ì¤‘)");
                return; // ìŠ¤íŒ¸ ì „ì†¡ ì™„í™”
            }
            console.log("âœ… ìŠ¤íŒ¸ ë°©ì§€ í†µê³¼");

            const payload = RankingSecurity.buildPayload(game, currentUser);
            console.log("ğŸ“¦ ë­í‚¹ í˜ì´ë¡œë“œ ìƒì„±:", payload);

            const verdict = RankingSecurity.isLikelyValid(payload);
            if (!verdict.ok) {
                console.warn("âŒ ë­í‚¹ ì „ì†¡ ì°¨ë‹¨ - ìœ íš¨ì„± ê²€ì¦ ì‹¤íŒ¨:", verdict.reason, payload);
                return;
            }
            console.log("âœ… ë°ì´í„° ìœ íš¨ì„± ê²€ì¦ í†µê³¼");

            // ê¸°ì¡´ Apps Script í˜¸í™˜ì„ ìœ„í•´ ê¸°ì¡´ í•„ë“œ ìœ ì§€ + ì¶”ê°€ í•„ë“œ(ì„œëª…/ì„¸ì…˜/ë²„ì „) í¬í•¨
            console.log("ë­í‚¹ ì„œë²„ë¡œ ì „ì†¡ ì‹œë„:", APPS_SCRIPT_URL);
            console.log("ğŸ“Š ë­í‚¹ ë°ì´í„°:", JSON.stringify(payload, null, 2));

            try {
                console.log("ğŸŒ GAS ì„œë²„ì— HTTP ìš”ì²­ ì‹œì‘");

                // URL íŒŒë¼ë¯¸í„°ë¡œ ë°ì´í„° ì „ì†¡ (no-cors ëª¨ë“œì—ì„œ ë” ì•ˆì •ì )
                const params = new URLSearchParams();
                params.append('action', 'save_ranking');
                params.append('username', payload.username);
                params.append('level', payload.level.toString());
                params.append('problems', payload.problems.toString());
                params.append('maxCombo', payload.maxCombo.toString());
                params.append('survivalTime', payload.survivalTime.toString());
                params.append('attempts', payload.attempts.toString());
                params.append('sessionId', payload.sessionId);
                params.append('signature', payload.signature);
                params.append('timestamp', payload.timestamp);

                const requestUrl = `${APPS_SCRIPT_URL}?${params.toString()}`;
                console.log("ğŸ”— ìš”ì²­ URL:", requestUrl);

                // GET ë°©ì‹ìœ¼ë¡œ URL íŒŒë¼ë¯¸í„° ì „ì†¡
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log("â° ìš”ì²­ íƒ€ì„ì•„ì›ƒ ì„¤ì •ë¨ (10ì´ˆ)");
                    controller.abort();
                }, 10000);

                console.log("ğŸ“¡ fetch ìš”ì²­ ì‹œì‘...");
                const response = await fetch(requestUrl, {
                    method: "GET",
                    mode: "no-cors",  // GASëŠ” CORSë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ no-cors ëª¨ë“œ ì‚¬ìš©
                    keepalive: true,  // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œì—ë„ ìš”ì²­ ì™„ë£Œ
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log("âœ… HTTP ìš”ì²­ ì™„ë£Œ (no-cors ëª¨ë“œ - ì‘ë‹µ ë‚´ìš© í™•ì¸ ë¶ˆê°€)");
                console.log("ğŸ“ GAS ì„œë²„ì˜ ì‹¤ì œ ì‘ë‹µì€ Apps Script ì‹¤í–‰ ë¡œê·¸ì—ì„œ í™•ì¸í•´ì•¼ í•¨");

            } catch(err) {
                if (err.name === 'AbortError') {
                    console.error("âŒ ìš”ì²­ íƒ€ì„ì•„ì›ƒ (10ì´ˆ ê²½ê³¼)");
                } else {
                    console.error("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", err.message);
                    console.error("âŒ ì˜¤ë¥˜ ìƒì„¸:", err);
                }
            }
        }

        function openRankingModal() {
            document.getElementById('rank-modal').style.display = 'flex';
            loadRanking('problems');

            // ë‚´ ê¸°ë¡ì— ë” ê°•í•œ ìŒì˜ í‘œì‹œ (ê¸°ì¡´ my-rank í´ë˜ìŠ¤ ê°•í™”)
            setTimeout(() => {
                const myRows = document.querySelectorAll('.my-rank');
                myRows.forEach(row => {
                    row.style.background = 'linear-gradient(90deg, rgba(79, 209, 197, 0.3), rgba(79, 209, 197, 0.1))';
                    row.style.borderLeft = '4px solid #4fd1c5';
                    row.style.fontWeight = 'bold';
                    row.style.color = '#fff';
                });
            }, 500);
        }

        function loadRanking(type) {
            const container = document.getElementById('rank-list-container');
            container.innerHTML = "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

            // ê° ë­í‚¹ íƒ€ì…ë³„ ê°•ì¡°í•  ì»¬ëŸ¼ ì¸ë±ìŠ¤ (LV ì—´ ì œê±°ë¡œ ì¸ë±ìŠ¤ ì¡°ì •)
            const highlightColumns = {
                'problems': 2,   // ì •ë‹µ ë¬¸ì œ ê°œìˆ˜ ì»¬ëŸ¼
                'combo': 3,      // ìµœëŒ€ì½¤ë³´ ì»¬ëŸ¼
                'survival': 4,   // ìƒì¡´ ì»¬ëŸ¼
                'accuracy': 5    // ì •ë‹µë¥  ì»¬ëŸ¼
            };

            // ë¡œì»¬ ë­í‚¹ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            let localRankings = [];
            const saved = localStorage.getItem('localRankings');
            if (saved) {
                try {
                    localRankings = JSON.parse(saved);
                } catch (e) {
                    console.error("Local rankings corrupted", e);
                    localRankings = [];
                }
            }

            // ë­í‚¹ ì •ë ¬
            let sortedData = [];
            if (type === 'problems') {
                sortedData = localRankings.sort((a, b) => b.problems - a.problems);
            } else if (type === 'combo') {
                sortedData = localRankings.sort((a, b) => b.maxCombo - a.maxCombo);
            } else if (type === 'survival') {
                sortedData = localRankings.sort((a, b) => b.survivalTime - a.survivalTime);
            } else if (type === 'accuracy') {
                sortedData = localRankings
                    .filter(r => r.attempts >= 100) // 100ë¬¸ì œ ì´ìƒë§Œ
                    .sort((a, b) => {
                        const accA = a.attempts > 0 ? (a.problems / a.attempts) : 0;
                        const accB = b.attempts > 0 ? (b.problems / b.attempts) : 0;
                        return accB - accA;
                    });
            }

            let html = `
                <table class="rank-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì´ë¦„</th>
                            <th>ì •ë‹µ ë¬¸ì œ ê°œìˆ˜</th>
                            <th>ì—°ì†ì •ë‹µìˆ˜</th>
                            <th>ìƒì¡´ì‹œê°„</th>
                            <th>ì •ë‹µë¥ (100ë¬¸ì œ ì´ìƒ)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            if (sortedData.length === 0) {
                html += `<tr><td colspan="7">ë“±ë¡ëœ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            } else {
                sortedData.forEach((row, index) => {
                    const isMe = row.username === currentUser;
                    const rank = index + 1;

                    // ì‹œê°„ í¬ë§·íŒ… (ì´ˆ -> ë¶„:ì´ˆ)
                    const sec = row.survivalTime || 0;
                    const min = Math.floor(sec / 60);
                    const s = sec % 60;
                    const timeStr = `${min}:${s.toString().padStart(2,'0')}`;

                    // ì •ë‹µë¥  ê³„ì‚°
                    let acc = 0;
                    const attempts = row.attempts || 0;
                    const correct = row.problems || 0;
                    if (attempts > 0) acc = ((correct / attempts) * 100).toFixed(1);

                    // ê°•ì¡°í•  ì»¬ëŸ¼ ê²°ì •
                    const highlightCol = highlightColumns[type] || -1;

                    html += `
                        <tr class="${isMe ? 'my-rank' : ''}">
                            <td>${rank}</td>
                            <td>${row.username}</td>
                            <td class="${highlightCol === 2 ? 'highlight-col' : ''}">${correct}</td>
                            <td class="${highlightCol === 3 ? 'highlight-col' : ''}">${row.maxCombo || 0}</td>
                            <td class="${highlightCol === 4 ? 'highlight-col' : ''}">${timeStr}</td>
                            <td class="${highlightCol === 5 ? 'highlight-col' : ''}">${attempts >= 100 ? acc + '%' : '-'}</td>
                        </tr>
                    `;
                });
            }
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // === 1. ìˆ˜í•™ ë¬¸ì œ ìƒì„±ê¸° ===
        class MathGen {
            constructor() {
                this.names = ['ì² ìˆ˜', 'ì˜í¬', 'ë¯¼ìˆ˜', 'ì§€ìˆ˜', 'í˜„ìš°', 'ë¯¼ì§€', 'ìˆ˜í˜„', 'í˜¸ì§„'];
                // ìƒí™©ë³„ í…œí”Œë¦¿ ì •ì˜
                this.scenarios = [
                    { item: 'ìˆ˜í•™ ì‹œí—˜ ì ìˆ˜', unit: 'ì ', action: 'ë°›ì•˜ìŠµë‹ˆë‹¤', question: 'í‰ê·  ì ìˆ˜', range: [70, 95] },
                    { item: 'ê°€ì§€ê³  ìˆëŠ” ì‚¬íƒ•', unit: 'ê°œ', action: 'ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤', question: 'ì‚¬íƒ•ì˜ í‰ê·  ê°œìˆ˜', range: [10, 40] },
                    { item: 'ì¤„ë„˜ê¸° ê¸°ë¡', unit: 'íšŒ', action: 'í–ˆìŠµë‹ˆë‹¤', question: 'ì¤„ë„˜ê¸° ê¸°ë¡ì˜ í‰ê· ', range: [30, 80] },
                    { item: 'ì½ì€ ì±…', unit: 'ê¶Œ', action: 'ì½ì—ˆìŠµë‹ˆë‹¤', question: 'ì½ì€ ì±…ì˜ í‰ê·  ê¶Œìˆ˜', range: [5, 20] },
                    { item: 'ëª¨ì€ ë”±ì§€', unit: 'ì¥', action: 'ëª¨ì•˜ìŠµë‹ˆë‹¤', question: 'ëª¨ì€ ë”±ì§€ì˜ í‰ê·  ê°œìˆ˜', range: [15, 50] }
                ];
            }

            getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

            generateProblem(level) {
                const isReverse = Math.random() > 0.5; // 50% í™•ë¥ ë¡œ ì—­ì‚° ë¬¸ì œ
                const scenario = this.scenarios[Math.floor(Math.random() * this.scenarios.length)];
                const count = this.getRandomInt(2, 3); // 2~3ëª… ë“±ì¥
                
                // ì´ë¦„ ëœë¤ ì„ íƒ
                let currentNames = [...this.names].sort(() => 0.5 - Math.random()).slice(0, count);
                
                // ë‚œì´ë„ì— ë”°ë¥¸ ê°’ ë²”ìœ„ ì¡°ì •
                let minVal = scenario.range[0] + (level * 2);
                let maxVal = scenario.range[1] + (level * 2);
                
                // í‰ê· ê°’ ë¨¼ì € ê²°ì • (ì •ìˆ˜ ë‹µì„ ìœ„í•´)
                let avg = this.getRandomInt(minVal, maxVal);
                let total = avg * count;
                
                // ê°œë³„ ê°’ ìƒì„± (í‰ê·  ì£¼ë³€ ê°’ìœ¼ë¡œ)
                let values = [];
                let currentSum = 0;
                for(let i=0; i<count-1; i++) {
                    let val = this.getRandomInt(avg - 10, avg + 10);
                    if(val < 0) val = 0; // ìŒìˆ˜ ë°©ì§€
                    values.push(val);
                    currentSum += val;
                }
                // ë§ˆì§€ë§‰ ê°’ì€ í•©ê³„ë¥¼ ë§ì¶”ê¸° ìœ„í•´ ê³„ì‚°
                let lastVal = total - currentSum;
                // ë§Œì•½ ë§ˆì§€ë§‰ ê°’ì´ ìŒìˆ˜ë©´ ë³´ì • (ë‹¨ìˆœí•˜ê²Œ ëª¨ë‘ í‰ê· ê°’ìœ¼ë¡œ í†µì¼)
                if (lastVal < 0) {
                    values = new Array(count-1).fill(avg);
                    lastVal = avg;
                }
                values.push(lastVal);
                
                // ê°’ ì„ê¸°
                values.sort(() => 0.5 - Math.random());

                let question = '';
                let answer = 0;

                if (!isReverse) {
                    // === ì •ë°©í–¥: í‰ê·  êµ¬í•˜ê¸° ===
                    // ì˜ˆ: ì² ìˆ˜ëŠ” 10ê°œ, ì˜í¬ëŠ” 20ê°œë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. í‰ê· ì€?
                    let sentence = "";
                    for(let i=0; i<count; i++) {
                        // ì¡°ì‚¬ ì²˜ë¦¬ (ê°„ë‹¨íˆ)
                        let sub = i === count-1 ? "" : ", ";
                        sentence += `${currentNames[i]}ëŠ” ${values[i]}${scenario.unit}${sub}`;
                    }
                    sentence += `ì„(ë¥¼) ${scenario.action}.`;
                    
                    question = `${scenario.item}ì— ëŒ€í•œ ì¡°ì‚¬ ê²°ê³¼ì…ë‹ˆë‹¤.\n${sentence}\n\nì´ ì¹œêµ¬ë“¤ì˜ ${scenario.question}ëŠ” ì–¼ë§ˆì…ë‹ˆê¹Œ?`;
                    answer = avg;

            } else {
                    // === ì—­ë°©í–¥: ê°’ êµ¬í•˜ê¸° ===
                    // ì˜ˆ: ë‘ ëª…ì˜ í‰ê· ì€ 15ê°œì…ë‹ˆë‹¤. ì² ìˆ˜ê°€ 10ê°œë¼ë©´ ì˜í¬ëŠ”?
                    let groupName = count === 2 ? `${currentNames[0]}ì™€(ê³¼) ${currentNames[1]}` : `${count}ëª…ì˜ ì¹œêµ¬ë“¤`;
                    
                    question = `${groupName}ì˜ ${scenario.item} í‰ê· ì€ ${avg}${scenario.unit}ì…ë‹ˆë‹¤.\n`;
                    
                    let knownPart = "";
                    for(let i=0; i<count-1; i++) {
                        knownPart += `${currentNames[i]}ëŠ” ${values[i]}${scenario.unit}`;
                        if(i < count-2) knownPart += ", ";
                    }
                    question += `${knownPart}ì¼ ë•Œ,\n\në‚˜ë¨¸ì§€ ${currentNames[count-1]}ì˜ ê°’ì€ ì–¼ë§ˆì…ë‹ˆê¹Œ?`;
                    
                    answer = values[count-1];
                }

                return { question, answer };
            }
        }

        // === 2. ê²Œì„ ì—”ì§„ ===
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameArea = document.getElementById('game-area');

        // ì´ë¯¸ì§€
        const imgHero = new Image(); imgHero.src = 'hero.png';
        const imgEnemy = new Image(); imgEnemy.src = 'devilking.png';

        // ì „ì—­ ë³€ìˆ˜
        let currentProblem = null;
        let isInputFocused = false;

        function isAndroidDevice() {
            const ua = navigator.userAgent || '';
            return /Android/i.test(ua);
        }

        class Game {
            constructor() {
                this.state = 'start'; 
                this.lastTime = 0;
                this.mathGen = new MathGen();

                // âœ… ì•ˆë“œë¡œì´ë“œ ëª¨ë°”ì¼ì—ì„œ í™”ë©´ì´ ì¤„ì–´ë“¤ ë•Œ(í‚¤ë³´ë“œ ë“±) ìºë¦­í„°ê°€ "ê¸‰ì ‘ê·¼"í•˜ëŠ” ì²´ê° ì™„í™”:
                // í”Œë ˆì´ì–´/ì /ì´ì•Œ/ì¶©ëŒ ë°˜ê²½ì„ 1/3ë¡œ ì¶•ì†Œ
                this.scale = isAndroidDevice() ? (1/3) : 1;
                
                this.player = {
                    x: 0, y: 0,
                    hp: 100, maxHp: 100,
                    level: 1,
                    damage: 25,
                    fireRate: 800,
                    lastFire: 0,
                    projectileCount: 1
                };

                this.gold = 0;
                this.skills = { bomb: 0, heal: 0, shield: 0 };
                this.isInvincible = false;

                this.enemies = [];
                this.bullets = [];
                this.particles = [];
                this.floatingTexts = [];

                this.spawnRate = 2000; // ì´ˆê¸° ìŠ¤í° 2ì´ˆ (ì—¬ìœ ë¡­ê²Œ ì‹œì‘)
                this.lastSpawn = 0;
                this.gameTime = 0; // ê²Œì„ ì§„í–‰ ì‹œê°„ ì¶”ì 

                // í˜„ì¬ ê²Œì„ í†µê³„
                this.stats = {
                    totalProblems: 0, 
                    attempts: 0,
                    correct: 0,
                    wrong: 0,
                    combo: 0,
                    maxCombo: 0
                };

                // ëˆ„ì  í†µê³„ (ë¡œë´‡ê³µê²© ë°©ì–´ ì§€ì›ì‹¤ í‘œì‹œìš©)
                this.globalStats = {
                    totalProblems: parseInt(localStorage.getItem('mathGlobalTotalProblems')) || 0,
                    attempts: parseInt(localStorage.getItem('mathGlobalAttempts')) || 0,
                    correct: parseInt(localStorage.getItem('mathGlobalCorrect')) || 0,
                    wrong: parseInt(localStorage.getItem('mathGlobalWrong')) || 0
                };

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìµœê³  ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                this.highScore = localStorage.getItem('mathHighLv') || 1;
                this.maxTime = parseFloat(localStorage.getItem('mathMaxTime')) || 0; // ms ë‹¨ìœ„
                
                // ì—­ëŒ€ ìµœê³  ì½¤ë³´ ë“± ì¶”ê°€ ê¸°ë¡
                this.bestCombo = parseInt(localStorage.getItem('mathBestCombo')) || 0;
                this.bestProblems = parseInt(localStorage.getItem('mathBestProblems')) || 0;

                window.addEventListener('resize', () => this.resize());
                // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì €ì¥
                window.addEventListener('beforeunload', () => this.saveGame());
                
                this.resize();
            }

            formatTime(ms) {
                const totalSec = Math.floor(ms / 1000);
                const m = Math.floor(totalSec / 60);
                const s = totalSec % 60;
                return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }

            resize() {
                // ì‚¬ì´ë“œë°”ë¥¼ ì œì™¸í•œ í¬ê¸°
                canvas.width = gameArea.clientWidth;
                canvas.height = gameArea.clientHeight;
                if (this.player.x === 0) {
                    this.player.x = canvas.width / 2;
                    this.player.y = canvas.height / 2;
                }
            }

            start() {
                document.getElementById('start-screen').style.display = 'none';
                this.state = 'playing';
                this.resize();
                this.player.x = canvas.width / 2;
                this.player.y = canvas.height / 2;

                this.loop(0);
                document.getElementById('bgm').play().catch(()=>{});
                
                this.updateHUD();
                this.updateSkillDock();
                this.nextProblem(); // ì²« ë¬¸ì œ ì¶œì œ
            }

            nextProblem() {
                // í€´ì¦ˆ ëª¨ë“œë¡œ ì „í™˜
                document.getElementById('quiz-container').style.display = 'flex';
                document.getElementById('upgrade-container').style.display = 'none';
                document.getElementById('answer-input').value = '';
                document.getElementById('answer-input').focus();

                currentProblem = this.mathGen.generateProblem(this.player.level);
                currentProblem.attempted = false; // ìƒˆë¡œìš´ ë¬¸ì œì´ë¯€ë¡œ ì‹œë„ í”Œë˜ê·¸ ì´ˆê¸°í™”

                // ë¬¸ì œ ìƒì„± ì‹œì—ëŠ” ì¹´ìš´íŠ¸í•˜ì§€ ì•Šê³ , ì‹¤ì œ ë‹µì„ ì‹œë„í•  ë•Œ ì¹´ìš´íŠ¸
                this.updateHUD(); // ì¦‰ì‹œ ë°˜ì˜

                document.getElementById('problem-text').innerText = `[LV.${this.player.level}]\n${currentProblem.question}`;
            }

            loop(timestamp) {
                if (this.state === 'paused' || this.state === 'gameover') {
                    if(this.state === 'paused') requestAnimationFrame((t) => this.loop(t)); // ë©ˆì¶°ìˆì–´ë„ ë£¨í”„ëŠ” ìœ ì§€ (ì¬ê°œ ìœ„í•´)
                return;
            }
            
                const dt = timestamp - this.lastTime;
                this.lastTime = timestamp;

                // ë¸íƒ€íƒ€ì„ ë³´ì • (ë„ˆë¬´ í° ê°’ ë°©ì§€)
                if (dt < 100) {
                    this.update(dt, timestamp);
                    this.draw();
                }

                requestAnimationFrame((t) => this.loop(t));
            }

            update(dt, timestamp) {
                this.gameTime += dt; // ê²Œì„ ì‹œê°„ ëˆ„ì 
                const seconds = this.gameTime / 1000;

                // === ë‚œì´ë„ ê³¡ì„  ì„¤ê³„ ===
                // 1. ì´ˆë°˜ 4ë¶„(240ì´ˆ): ìŠ¤í° ì†ë„ 2.0ì´ˆ -> 1.0ì´ˆë¡œ ì„œì„œíˆ ê°ì†Œ
                // 2. ì¤‘ë°˜(240ì´ˆ~): ìŠ¤í° ì†ë„ 1.0ì´ˆ -> 0.5ì´ˆ
                // 3. í›„ë°˜(480ì´ˆ~): ìŠ¤í° ì†ë„ 0.3ì´ˆ (ë¬¼ëŸ‰ í­ì£¼)
                
                let currentSpawnRate = 2000;
                if (seconds < 180) {
                    // 4ë¶„ê¹Œì§€ëŠ” ì²œì²œíˆ ë¹¨ë¼ì§
                    currentSpawnRate = 2000 - (seconds * 4); // 240ì´ˆì¼ ë•Œ ì•½ 1000ms
                } else if (seconds < 480) {
                    // 4ë¶„~8ë¶„: ì¡°ê¸ˆ ë” ë¹¨ë¼ì§
                    currentSpawnRate = 1000 - ((seconds - 240) * 2); // 480ì´ˆì¼ ë•Œ ì•½ 500ms
                } else {
                    // 8ë¶„ ì´í›„: ê·¹í•œ
                    currentSpawnRate = 500 - ((seconds - 480) * 3);
                    if (currentSpawnRate < 300) currentSpawnRate = 300;
                }
                this.spawnRate = currentSpawnRate;

                // ì  ìŠ¤í°
                if (timestamp - this.lastSpawn > this.spawnRate) {
                    this.spawnEnemy();
                    
                    // 4ë¶„ ì´í›„ë¶€í„° ë¬¼ëŸ‰ í­ì£¼ í™•ë¥  ìƒê¹€ (ì ì§„ì  ì¦ê°€)
                    if (seconds > 240 && Math.random() < 0.1) this.spawnEnemy(); 
                    if (seconds > 480 && Math.random() < 0.2) this.spawnEnemy();

                    this.lastSpawn = timestamp;
                }

                // ìë™ ê³µê²©
                if (timestamp - this.player.lastFire > this.player.fireRate) {
                    this.fireBullet();
                    this.player.lastFire = timestamp;
                }

                // ì´ì•Œ ì´ë™
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    let b = this.bullets[i];
                    b.x += b.vx * dt * 0.06;
                    b.y += b.vy * dt * 0.06;

                    if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) {
                        this.bullets.splice(i, 1);
                        continue;
                    }

                    for (let j = this.enemies.length - 1; j >= 0; j--) {
                        let e = this.enemies[j];
                        let dist = Math.hypot(b.x - e.x, b.y - e.y);
                        const bulletRadius = 8 * this.scale;
                        if (dist < e.radius + bulletRadius) {
                            e.hp -= this.player.damage;
                            this.showDamage(e.x, e.y, this.player.damage);
                            this.bullets.splice(i, 1);
                            if (e.hp <= 0) this.killEnemy(j);
                    break;    
            }
                    }
                }

                // ì  ì´ë™
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    let e = this.enemies[i];
                    let angle = Math.atan2(this.player.y - e.y, this.player.x - e.x);
                    e.x += Math.cos(angle) * e.speed * dt * 0.06;
                    e.y += Math.sin(angle) * e.speed * dt * 0.06;

                    let dist = Math.hypot(this.player.x - e.x, this.player.y - e.y);
                    // í”Œë ˆì´ì–´ í”¼ê²© ë²”ìœ„ ì¡°ì • (30 -> 60)
                    const playerHitRadius = 60 * this.scale;
                    if (dist < playerHitRadius + e.radius) {
                        if (!this.isInvincible) {
                            // í”Œë ˆì´ì–´ í”¼ê²© ë°ë¯¸ì§€ ì¡°ì • (1.0 -> 0.5)
                            this.player.hp -= 0.5; 
                            this.updateHUD();
                            if (this.player.hp <= 0) this.gameOver();
                        }
                    }
                }

                // íŒŒí‹°í´
                this.particles.forEach((p, i) => {
                    p.life -= dt;
                    p.x += p.vx; p.y += p.vy;
                    if (p.life <= 0) this.particles.splice(i, 1);
                });
                
                // í…ìŠ¤íŠ¸
                this.floatingTexts.forEach((t, i) => {
                    t.life -= dt; t.y -= 0.5;
                    if (t.life <= 0) this.floatingTexts.splice(i, 1);
                });
            }

            draw() {
                // ìš°ì£¼ ë°°ê²½ ê·¸ë¦¬ê¸°
                // 1. ê¹Šì€ ìš°ì£¼ìƒ‰ ë°°ê²½
                ctx.fillStyle = '#0b0d17'; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 2. ë³„ ê·¸ë¦¬ê¸° (ëœë¤ ìœ„ì¹˜ì— ë³„ ìƒì„±)
                // ë§¤ í”„ë ˆì„ë§ˆë‹¤ ê·¸ë¦¬ë©´ ë²ˆì©ê±°ë¦¬ë¯€ë¡œ, ë¯¸ë¦¬ ìƒì„±ëœ ë³„ ë°°ì—´ì„ ì‚¬ìš©í•˜ê±°ë‚˜
                // ê°„ë‹¨í•˜ê²Œ ëœë¤ ì‹œë“œë¡œ ê³ ì •ëœ ë³„ì„ ê·¸ë¦¼.
                // ì—¬ê¸°ì„œëŠ” ì„±ëŠ¥ì„ ìœ„í•´ ë‹¨ìˆœ ë‚œìˆ˜ë¡œ ë§¤ë²ˆ ê·¸ë¦¬ì§€ ì•Šê³ ,
                // í™”ë©´ ì¢Œí‘œ ê¸°ë°˜ìœ¼ë¡œ ì˜ì‚¬ ë‚œìˆ˜ë¥¼ ìƒì„±í•˜ì—¬ ê³ ì •ëœ ë³„ì²˜ëŸ¼ ë³´ì´ê²Œ í•¨.
                
                ctx.fillStyle = '#ffffff';
                for (let i = 0; i < 100; i++) {
                    // ê°„ë‹¨í•œ í•´ì‹œ í•¨ìˆ˜ë¡œ ì¢Œí‘œ ê³ ì •
                    const x = (Math.sin(i * 123.45) * 0.5 + 0.5) * canvas.width;
                    const y = (Math.cos(i * 678.90) * 0.5 + 0.5) * canvas.height;
                    const size = (Math.sin(i * 999) + 2) / 2; // 0.5 ~ 1.5
                    const twinkle = Math.sin(performance.now() / 200 + i); // ë°˜ì§ì„
                    
                    ctx.globalAlpha = 0.5 + twinkle * 0.3;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1.0;

                // Enemies
                this.enemies.forEach(e => {
                    ctx.drawImage(imgEnemy, e.x - e.radius, e.y - e.radius, e.radius*2, e.radius*2);
                    // HP Bar
                    ctx.fillStyle = 'red'; ctx.fillRect(e.x-15, e.y-e.radius-8, 30, 4);
                    ctx.fillStyle = 'green'; ctx.fillRect(e.x-15, e.y-e.radius-8, 30*(e.hp/e.maxHp), 4);
                });

                // Bullets
                ctx.fillStyle = '#4fd1c5';
                const bulletRadius = 8 * this.scale;
                this.bullets.forEach(b => {
                    ctx.beginPath(); ctx.arc(b.x, b.y, bulletRadius, 0, Math.PI*2); ctx.fill();
                });

                // Player
                ctx.save();
                ctx.translate(this.player.x, this.player.y);
                if (this.isInvincible && (Math.floor(Date.now()/100)%2===0)) ctx.globalAlpha = 0.5;
                
                // í”Œë ˆì´ì–´ í¬ê¸° (ëª¨ë°”ì¼ ì•ˆë“œë¡œì´ë“œì—ì„œëŠ” 1/3 ì¶•ì†Œ)
                const half = 70 * this.scale;
                ctx.drawImage(imgHero, -half, -half, half*2, half*2);
                
                if(this.isInvincible) {
                    ctx.beginPath(); ctx.strokeStyle='#00ffff'; ctx.lineWidth=3;
                    ctx.arc(0,0,80*this.scale,0,Math.PI*2); ctx.stroke();
                }
                ctx.restore();

                // Particles
                this.particles.forEach(p => {
                    ctx.fillStyle = p.color; ctx.globalAlpha = p.life/500;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
                });
                ctx.globalAlpha = 1;

                // Floating Text
                this.floatingTexts.forEach(t => {
                    ctx.fillStyle = t.color; ctx.font = 'bold 20px Jua';
                    ctx.fillText(t.text, t.x, t.y);
                });
            }

            spawnEnemy() {
                let x, y;
                if(Math.random()<0.5) {
                    const pad = 30 * this.scale;
                    x = Math.random()<0.5 ? -pad : canvas.width+pad; y = Math.random()*canvas.height;
                } else {
                    const pad = 30 * this.scale;
                    x = Math.random()*canvas.width; y = Math.random()<0.5 ? -pad : canvas.height+pad;
                }
                
                const seconds = this.gameTime / 1000;
                
                // ê¸°ë³¸ ì²´ë ¥ 30
                // 4ë¶„(240ì´ˆ)ê¹Œì§€ëŠ” ì‹œê°„ë‹¹ ì²´ë ¥ ì¦ê°€ ê±°ì˜ ì—†ìŒ (ë§¤ìš° ë¯¸ë¯¸)
                // 4ë¶„ ì´í›„ë¶€í„° ì²´ë ¥ ì¦ê°€ ì‹œì‘
                
                let timeHpBonus = 0;
                if (seconds > 240) {
                    timeHpBonus = (seconds - 240) * 0.5; // 4ë¶„ ì´í›„ 2ì´ˆë‹¹ 1 ì¦ê°€
                }
                
                // ë ˆë²¨ì— ë”°ë¥¸ ì²´ë ¥ ì¦ê°€ (ì‚¬ìš©ìê°€ ê°•í•´ì§„ ë§Œí¼ ì ë„ ê°•í•´ì§)
                const levelHpBonus = this.player.level * 5; 

                const hp = 30 + levelHpBonus + timeHpBonus;
                
                // ì†ë„: 4ë¶„ê¹Œì§€ëŠ” ëŠë¦¼(1.0~1.5), ê·¸ ì´í›„ ì ì°¨ ë¹¨ë¼ì§
                let baseSpeed = 1.0;
                if (seconds > 240) baseSpeed += (seconds - 240) * 0.005;
                
                const speed = Math.min(4.0, baseSpeed + Math.random() * 0.5);

                // ì  í¬ê¸° (ëª¨ë°”ì¼ ì•ˆë“œë¡œì´ë“œì—ì„œëŠ” 1/3 ì¶•ì†Œ)
                const radius = 50 * this.scale;
                this.enemies.push({ x, y, hp, maxHp: hp, radius, speed: speed });
            }

            fireBullet() {
                if(this.enemies.length===0) return;
                // ê°€ê¹Œìš´ ì 
                let target = this.enemies.reduce((a, b) => {
                    let distA = Math.hypot(a.x-this.player.x, a.y-this.player.y);
                    let distB = Math.hypot(b.x-this.player.x, b.y-this.player.y);
                    return distA < distB ? a : b;
                });

                const angle = Math.atan2(target.y - this.player.y, target.x - this.player.x);
                const count = this.player.projectileCount;
                const spread = 0.2;
                const startAngle = angle - (spread*(count-1))/2;

                for(let i=0; i<count; i++){
                    let th = startAngle + spread*i;
                    this.bullets.push({ x: this.player.x, y: this.player.y, vx: Math.cos(th)*12, vy: Math.sin(th)*12 });
                }
                document.getElementById('sfx-shoot').currentTime=0;
                document.getElementById('sfx-shoot').play().catch(()=>{});
            }

            killEnemy(idx) {
                const e = this.enemies[idx];
                for(let i=0; i<5; i++) this.particles.push({
                    x:e.x, y:e.y, vx:(Math.random()-0.5)*5, vy:(Math.random()-0.5)*5,
                    life:300, color:'red', size:3
                });
                this.enemies.splice(idx, 1);
                this.gold += 10;
                this.updateHUD();
            }

            showDamage(x, y, txt) {
                this.floatingTexts.push({ x, y, text: txt, life: 40, color: '#fff' });
            }

            updateHUD() {
                document.getElementById('hpBar').style.width = `${Math.max(0, this.player.hp)}%`;
                document.getElementById('hpText').innerText = `HP ${Math.ceil(this.player.hp)}/${this.player.maxHp}`;
                document.getElementById('goldDisplay').innerText = this.gold;

                // ë‹‰ë„¤ì„ í‘œì‹œ
                console.log('ë‹‰ë„¤ì„ í‘œì‹œ:', currentUser);
                const nicknameEl = document.getElementById('user-nickname');
                const nicknameDisplayEl = document.getElementById('nickname-display');

                const displayName = currentUser || 'ì•Œ ìˆ˜ ì—†ìŒ';

                if (nicknameEl) {
                    nicknameEl.innerText = displayName;
                }
                if (nicknameDisplayEl) {
                    nicknameDisplayEl.innerText = `ë‹‰ë„¤ì„: ${displayName}`;
                }

                // ë‚œì´ë„ í‘œì‹œ
                const sec = this.gameTime / 1000;
                let diffText = "í‰í™”";
                let diffColor = "#4fd1c5"; // green
                if (sec > 240) { diffText = "ê¸´ì¥"; diffColor = "#f6ad55"; } // orange
                if (sec > 480) { diffText = "ìœ„ê¸°"; diffColor = "#f56565"; } // red
                
                const diffEl = document.getElementById('diff-display');
                diffEl.innerText = diffText;
                diffEl.style.color = diffColor;

                // ì‹œê°„ í‘œì‹œ
                document.getElementById('timer-display').innerText = this.formatTime(this.gameTime);
                document.getElementById('max-time').innerText = this.formatTime(Math.max(this.gameTime, this.maxTime));

                // ëŠ¥ë ¥ì¹˜ í‘œì‹œ
                document.getElementById('stat-dmg').innerText = this.player.damage;
                document.getElementById('stat-spd').innerText = (1000 / this.player.fireRate).toFixed(2);
                document.getElementById('stat-cnt').innerText = this.player.projectileCount;
                document.getElementById('enemy-dmg').innerText = "0.5"; // í˜„ì¬ ê³ ì • ë°ë¯¸ì§€

                // í•™ìŠµ í†µê³„ í‘œì‹œ (ëˆ„ì )
                document.getElementById('stat-total-problems').innerText = this.globalStats.totalProblems;
                document.getElementById('stat-attempts').innerText = this.globalStats.attempts;
                document.getElementById('stat-correct').innerText = this.globalStats.correct;
                document.getElementById('stat-wrong').innerText = this.globalStats.wrong;
                
                // ì½¤ë³´ëŠ” í˜„ì¬ ê²Œì„ ê¸°ì¤€
                document.getElementById('stat-combo').innerText = this.stats.combo;
                // ìµœëŒ€ ì½¤ë³´ëŠ” ì—­ëŒ€ ìµœê³  ê¸°ë¡
                const displayMaxCombo = Math.max(this.stats.maxCombo, this.bestCombo);
                document.getElementById('stat-max-combo').innerText = `(ìµœê³ : ${displayMaxCombo})`;
                
                // ì •ë‹µë¥  (ëˆ„ì )
                let acc = 0;
                if (this.globalStats.attempts > 0) {
                    acc = ((this.globalStats.correct / this.globalStats.attempts) * 100).toFixed(1);
                }
                document.getElementById('stat-accuracy').innerText = `${acc}%`;
            }

            updateSkillDock() {
                document.getElementById('cnt-bomb').innerText = this.skills.bomb;
                document.getElementById('cnt-heal').innerText = this.skills.heal;
                document.getElementById('cnt-shield').innerText = this.skills.shield;
                document.querySelectorAll('.skill-slot')[0].classList.toggle('empty', this.skills.bomb<=0);
                document.querySelectorAll('.skill-slot')[1].classList.toggle('empty', this.skills.heal<=0);
                document.querySelectorAll('.skill-slot')[2].classList.toggle('empty', this.skills.shield<=0);
            }

            toggleShop() {
                const modal = document.getElementById('shop-modal');
                if(modal.style.display==='flex') {
                    modal.style.display='none';
                    this.lastTime = performance.now();
                    this.state='playing';
                    this.loop(this.lastTime);
            } else {
                    modal.style.display='flex';
                    this.state='paused';
                    document.getElementById('shop-gold').innerText=this.gold;
                }
            }
            
            async gameOver() {
                if (this.state === 'gameover') return;
                this.state = 'gameover';
                document.getElementById('sfx-over').play().catch(()=>{});

                console.log("ğŸ® ê²Œì„ ì˜¤ë²„ - ê¸°ë¡ ë¶„ì„ ì‹œì‘");
                console.log(`ğŸ“Š ê²Œì„ í†µê³„: ìƒì¡´ì‹œê°„=${this.formatTime(this.gameTime)}, ì •ë‹µ=${this.stats.correct}, ì½¤ë³´=${this.stats.maxCombo}, ì‹œë„=${this.stats.attempts}`);

                // ìµœê³  ê¸°ë¡ ê°±ì‹  (ì‹œê°„, ì½¤ë³´, ë¬¸ì œìˆ˜)
                let isNewRecord = false;
                if (this.gameTime > this.maxTime) {
                    this.maxTime = this.gameTime;
                    localStorage.setItem('mathMaxTime', this.maxTime);
                    isNewRecord = true;
                    console.log("ğŸ† ìµœê³  ìƒì¡´ì‹œê°„ ê°±ì‹ :", this.formatTime(this.maxTime));
                }
                if (this.stats.correct > this.bestProblems) {
                    this.bestProblems = this.stats.correct;
                    localStorage.setItem('mathBestProblems', this.bestProblems);
                    isNewRecord = true;
                    console.log("ğŸ† ìµœê³  ì •ë‹µìˆ˜ ê°±ì‹ :", this.bestProblems);
                }
                if (this.stats.maxCombo > this.bestCombo) {
                    this.bestCombo = this.stats.maxCombo;
                    localStorage.setItem('mathBestCombo', this.bestCombo);
                    isNewRecord = true;
                    console.log("ğŸ† ìµœê³  ì½¤ë³´ ê°±ì‹ :", this.bestCombo);
                }

                // ë¡œì»¬ ë­í‚¹ ì €ì¥ (ì˜¤í”„ë¼ì¸ ë­í‚¹ ì‹œìŠ¤í…œ)
                console.log("ğŸ’¾ ë¡œì»¬ ë­í‚¹ ì €ì¥ ì‹œì‘");
                this.saveLocalRanking();
                console.log("âœ… ë¡œì»¬ ë­í‚¹ ì €ì¥ ì™„ë£Œ");

                // ë­í‚¹ ì „ì†¡ (ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬ - í˜ì´ì§€ ë¦¬ë¡œë“œì™€ ë¬´ê´€í•˜ê²Œ)
                console.log("ğŸ“¤ GAS ë­í‚¹ ì „ì†¡ ì‹œì‘");
                sendRanking().then(() => {
                    console.log("âœ… GAS ë­í‚¹ ì „ì†¡ ì„±ê³µ");
                }).catch(e => {
                    console.error("âŒ GAS ë­í‚¹ ì „ì†¡ ì‹¤íŒ¨:", e);
                });

                localStorage.removeItem('mathSaveData');

                let msg = `ê²Œì„ ì˜¤ë²„!\nìƒì¡´ ì‹œê°„: ${this.formatTime(this.gameTime)}\nì´ë²ˆ íŒ í•´ê²°: ${this.stats.correct}ë¬¸ì œ`;
                if(isNewRecord) msg += `\nğŸ‰ ìƒˆë¡œìš´ ìµœê³  ê¸°ë¡ ë‹¬ì„±!`;

                // UI ë Œë”ë§ ë£¨í”„ ë“± í™•ì‹¤íˆ ì¢…ë£Œ í›„ ì•Œë¦¼
                setTimeout(() => {
                    alert(msg);
                    location.reload();
                }, 100);
            }

            saveGame() {
                if (this.state !== 'playing' && this.state !== 'paused') return;
                
                const saveData = {
                    gameTime: this.gameTime,
                    player: this.player,
                    gold: this.gold,
                    skills: this.skills,
                    stats: this.stats,
                    spawnRate: this.spawnRate,
                    // ì ë“¤ ìœ„ì¹˜ê¹Œì§€ ì €ì¥í•˜ë©´ ì¢‹ì§€ë§Œ ë„ˆë¬´ ë§ìœ¼ë¯€ë¡œ ìƒëµí•˜ê±°ë‚˜ ê°„ëµíˆ ì €ì¥
                    // ì—¬ê¸°ì„œëŠ” ì  ì •ë³´ëŠ” ì´ˆê¸°í™”í•˜ê³  ë‚œì´ë„(ì‹œê°„)ë§Œ ìœ ì§€í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ íƒ€í˜‘í•  ìˆ˜ë„ ìˆì§€ë§Œ,
                    // ì •í™•í•œ ë³µêµ¬ë¥¼ ìœ„í•´ ì  ì •ë³´ë„ ì¼ë¶€ ì €ì¥
                    // ë‹¤ë§Œ ì ì´ ë„ˆë¬´ ë§ìœ¼ë©´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ìš©ëŸ‰ ì´ìŠˆê°€ ìˆì„ ìˆ˜ ìˆìŒ (í…ìŠ¤íŠ¸ë¼ ê´œì°®ì„ ë“¯)
                    level: this.player.level
                };
                localStorage.setItem('mathSaveData', JSON.stringify(saveData));
            }

            saveLocalRanking() {
                console.log("ğŸ’½ saveLocalRanking í•¨ìˆ˜ ì‹œì‘");

                if (!currentUser) {
                    console.log("âŒ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ - ë¡œì»¬ ë­í‚¹ ì €ì¥ ì·¨ì†Œ");
                    return;
                }

                const survivalTime = Math.floor(this.gameTime / 1000);
                const accuracy = this.stats.attempts > 0 ? ((this.stats.correct / this.stats.attempts) * 100).toFixed(1) : 0;

                const rankingEntry = {
                    username: currentUser,
                    level: this.player.level,
                    problems: this.stats.correct,
                    maxCombo: this.stats.maxCombo,
                    survivalTime: survivalTime,
                    attempts: this.stats.attempts,
                    timestamp: new Date().toISOString()
                };

                console.log("ğŸ“ ìƒì„±ëœ ë­í‚¹ í•­ëª©:", rankingEntry);

                // ê¸°ì¡´ ë¡œì»¬ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸°
                let localRankings = [];
                const saved = localStorage.getItem('localRankings');
                console.log("ğŸ“š ê¸°ì¡´ ë¡œì»¬ ë­í‚¹ ë°ì´í„°:", saved ? "ìˆìŒ" : "ì—†ìŒ");

                if (saved) {
                    try {
                        localRankings = JSON.parse(saved);
                        console.log("ğŸ“– ë¡œì»¬ ë­í‚¹ íŒŒì‹± ì„±ê³µ, í•­ëª© ìˆ˜:", localRankings.length);
                    } catch (e) {
                        console.error("âŒ ë¡œì»¬ ë­í‚¹ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:", e);
                        localRankings = [];
                    }
                }

                // ë™ì¼ ì‚¬ìš©ìì˜ ê¸°ì¡´ ê¸°ë¡ ì°¾ê¸°
                const existingIndex = localRankings.findIndex(r => r.username === currentUser);
                console.log("ğŸ” ê¸°ì¡´ ì‚¬ìš©ì ê¸°ë¡ ì°¾ê¸°:", existingIndex >= 0 ? `ì¸ë±ìŠ¤ ${existingIndex}ì— ìˆìŒ` : "ìƒˆë¡œìš´ ì‚¬ìš©ì");

                if (existingIndex >= 0) {
                    // ê¸°ì¡´ ê¸°ë¡ ì—…ë°ì´íŠ¸ (ë” ì¢‹ì€ ê¸°ë¡ìœ¼ë¡œ)
                    const existing = localRankings[existingIndex];
                    const shouldUpdate = rankingEntry.level > existing.level ||
                        rankingEntry.problems > existing.problems ||
                        rankingEntry.maxCombo > existing.maxCombo ||
                        rankingEntry.survivalTime > existing.survivalTime;

                    if (shouldUpdate) {
                        console.log("ğŸ”„ ê¸°ì¡´ ê¸°ë¡ ì—…ë°ì´íŠ¸");
                        localRankings[existingIndex] = rankingEntry;
                    } else {
                        console.log("â­ï¸ ê¸°ì¡´ ê¸°ë¡ì´ ë” ì¢‹ìŒ - ì—…ë°ì´íŠ¸ ìƒëµ");
                    }
                } else {
                    // ìƒˆ ê¸°ë¡ ì¶”ê°€
                    console.log("â• ìƒˆ ê¸°ë¡ ì¶”ê°€");
                    localRankings.push(rankingEntry);
                }

                // ìµœëŒ€ 100ê°œ ê¸°ë¡ ìœ ì§€
                if (localRankings.length > 100) {
                    console.log("ğŸ—‚ï¸ ê¸°ë¡ ìˆ˜ ì œí•œ ì ìš© (100ê°œ ìœ ì§€)");
                    localRankings = localRankings.slice(-100);
                }

                // ì €ì¥
                localStorage.setItem('localRankings', JSON.stringify(localRankings));
                console.log("âœ… ë¡œì»¬ ë­í‚¹ ì €ì¥ ì™„ë£Œ, ì´ í•­ëª© ìˆ˜:", localRankings.length);
                console.log("ğŸ“‹ ìµœì¢… ì €ì¥ëœ ë­í‚¹ ë°ì´í„°:", localRankings);
            }

            loadGame() {
                const json = localStorage.getItem('mathSaveData');
                if (!json) return false;

                try {
                    const data = JSON.parse(json);
                    this.gameTime = data.gameTime || 0;

                    // í”Œë ˆì´ì–´ ìŠ¤íƒ¯ ë³µêµ¬
                    Object.assign(this.player, data.player);
                    this.gold = data.gold;
                    this.skills = data.skills;
                    Object.assign(this.stats, data.stats);
                    this.spawnRate = data.spawnRate;

                    // HUD ê°±ì‹ 
                    this.updateHUD();
                    this.updateSkillDock();

                    // ë¬¸ì œ í…ìŠ¤íŠ¸ ê°±ì‹  (ë§ˆì§€ë§‰ ë ˆë²¨ ê¸°ì¤€ ë¬¸ì œ ì¬ìƒì„±)
                    this.nextProblem();

                    return true;
                } catch (e) {
                    console.error("Save file corrupted", e);
                    return false;
                }
            }
        }

        // === ê²Œì„ ì¸ìŠ¤í„´ìŠ¤ ===
        let game = new Game();

        function startGame() {
            console.log('ê²Œì„ ì‹œì‘, í˜„ì¬ ì‚¬ìš©ì:', currentUser);
            game.start();
        }

        // === UI ì¸í„°ë™ì…˜ ===
        function checkEnter(e) {
            if(e.key === 'Enter') submitAnswer();
        }

        function submitAnswer() {
            const input = document.getElementById('answer-input');
            const val = parseInt(input.value);

            if (isNaN(val)) {
                showToast("ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            // ì´ë²ˆ íŒ í†µê³„ ê°±ì‹  (ì²« ì œì¶œì‹œì—ë§Œ ë¬¸ì œ ìˆ˜ ì¹´ìš´íŠ¸)
            if (!currentProblem.attempted) {
                currentProblem.attempted = true;
                game.stats.totalProblems++;
                game.globalStats.totalProblems++; // ëˆ„ì  ì¦ê°€
                // ëˆ„ì  í†µê³„ ì €ì¥
                localStorage.setItem('mathGlobalTotalProblems', game.globalStats.totalProblems);
            }

            game.stats.attempts++;

            // ëˆ„ì  í†µê³„ ê°±ì‹ 
            game.globalStats.attempts++;
            localStorage.setItem('mathGlobalAttempts', game.globalStats.attempts);

            if (val === currentProblem.answer) {
                showToast("ì •ë‹µ! ì—…ê·¸ë ˆì´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
                document.getElementById('sfx-level').play().catch(()=>{});
                
                // ì´ë²ˆ íŒ í†µê³„ ê°±ì‹ 
                game.stats.correct++;
                game.stats.combo++;
                if(game.stats.combo > game.stats.maxCombo) game.stats.maxCombo = game.stats.combo;
                
                // ëˆ„ì  í†µê³„ ê°±ì‹ 
                game.globalStats.correct++;
                localStorage.setItem('mathGlobalCorrect', game.globalStats.correct);
                
                game.updateHUD();
                
                // ì—…ê·¸ë ˆì´ë“œ ëª¨ë“œë¡œ ì „í™˜
                const quizArea = document.getElementById('quiz-container');
                const upgradeArea = document.getElementById('upgrade-container');
                quizArea.style.display = 'none';
                upgradeArea.style.display = 'flex';
                upgradeArea.innerHTML = '';

                // ì—…ê·¸ë ˆì´ë“œ ì˜µì…˜ ìƒì„±
                const opts = [
                    { name: 'ê³µê²©ë ¥ +10', apply: () => game.player.damage += 10 },
                    { name: 'HP íšŒë³µ & ìµœëŒ€ +50', apply: () => { game.player.maxHp+=50; game.player.hp=game.player.maxHp; } },
                    { name: 'ì—°ì‚¬ë ¥ +15%', apply: () => game.player.fireRate *= 0.85 },
                    { name: 'ë‹¤ì¤‘ ì‚¬ê²© +1', apply: () => game.player.projectileCount++ }
                ];
                
                opts.forEach(opt => {
                    let div = document.createElement('div');
                    div.className = 'upgrade-card';
                    div.innerHTML = `<div class="upgrade-title">${opt.name}</div>`;
                    div.onclick = () => {
                        opt.apply();
                        showToast("ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ!");
                        game.player.level++;
                        game.nextProblem();
                    };
                    upgradeArea.appendChild(div);
                });

            } else {
                showToast("ì˜¤ë‹µì…ë‹ˆë‹¤! ë‹¤ì‹œ í’€ì–´ë³´ì„¸ìš”.");
                
                // ì´ë²ˆ íŒ í†µê³„ ê°±ì‹ 
                game.stats.combo = 0; // ì½¤ë³´ ì´ˆê¸°í™”
                game.stats.wrong++;
                
                // ëˆ„ì  í†µê³„ ê°±ì‹ 
                game.globalStats.wrong++;
                localStorage.setItem('mathGlobalWrong', game.globalStats.wrong);

                game.updateHUD();
                
                input.value = '';
                input.focus();
                // íŒ¨ë„í‹°: ì ë“¤ íšŒë³µ
                game.enemies.forEach(e => e.hp = e.maxHp);
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(()=> t.style.opacity=0, 2000);
        }

        // ìŠ¤í‚¬ ë° í¬ì»¤ìŠ¤ ê´€ë¦¬
        const inputField = document.getElementById('answer-input');
        inputField.addEventListener('focus', () => isInputFocused = true);
        inputField.addEventListener('blur', () => isInputFocused = false);

        document.addEventListener('keydown', (e) => {
            if (isInputFocused) return; // ì…ë ¥ ì¤‘ì¼ ë• ë‹¨ì¶•í‚¤ ë¬´ì‹œ
            if (e.key === '1') useSkill('bomb');
            if (e.key === '2') useSkill('heal');
            if (e.key === '3') useSkill('shield');
        });

        function buySkill(type, cost) {
            if(game.gold >= cost) {
                game.gold -= cost;
                game.skills[type]++;
                game.updateHUD();
                game.updateSkillDock();
                document.getElementById('shop-gold').innerText = game.gold;
            } else {
                alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            }
        }

        function useSkill(type) {
            if(game.state !== 'playing') return;
            if(game.skills[type] > 0) {
                game.skills[type]--;
                game.updateSkillDock();
                
                if(type==='bomb') {
                    game.enemies = [];
                    document.getElementById('sfx-hit').play().catch(()=>{});
                } else if(type==='heal') {
                    game.player.hp = game.player.maxHp;
                    game.updateHUD();
                } else if(type==='shield') {
                    game.isInvincible = true;
                    setTimeout(()=>game.isInvincible=false, 5000);
                }
            }
        }

        

    </script>




    <!-- ë²„ì „ ì •ë³´ ì›Œí„°ë§ˆí¬ -->
    <div style="
        position: fixed;
        bottom: 5px;
        right: 10px;
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.3);
        pointer-events: none;
        z-index: 9999;
        text-align: right;
        font-family: sans-serif;
    ">
        the-hero-robot-invasion<br>
        made by gametudyssam 0.023
    </div>

</body>
</html>
